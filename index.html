<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https://jflxkrlxlvhrntodywth.supabase.co https://cdn.jsdelivr.net; img-src 'self' data: blob:;">
<title>Intakr – Client Intake System</title>
<script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.95.3"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --sage:#8FAF8F;--sage-light:#B5CDB5;--sage-pale:#E8F0E8;--sage-dark:#6B8F6B;
    --charcoal:#2C2C2C;--warm-gray:#6B6B6B;--light-gray:#F5F5F3;
    --cream:#FAFAF8;--white:#FFFFFF;--border:#E0E0DC;
    --error:#C0392B;--amber:#E6A817;--amber-pale:#FFF8E1;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--charcoal);line-height:1.6;min-height:100vh;}
  .app-container{display:none;}.app-container.visible{display:block;}
  .header{background:var(--white);border-bottom:1px solid var(--border);padding:24px 40px;display:flex;align-items:center;justify-content:space-between;}
  .header-left{display:flex;align-items:center;gap:20px;}
  .header-logo{height:48px;width:48px;}
  .header-divider{width:1px;height:36px;background:var(--border);}
  .header-text h1{font-size:26px;font-weight:700;letter-spacing:-0.5px;}
  .header-text p{font-size:11px;color:var(--warm-gray);text-transform:uppercase;letter-spacing:1.8px;font-weight:600;margin-top:-2px;}
  .header-right{display:flex;align-items:center;gap:12px;}
  .header-badge{background:var(--sage-pale);color:var(--sage-dark);font-size:11px;font-weight:600;padding:6px 14px;border-radius:20px;letter-spacing:0.5px;text-transform:uppercase;}
  .user-menu{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--sage-pale);border-radius:20px;font-size:12px;color:var(--sage-dark);font-weight:500;}
  .user-menu button{background:none;border:none;color:var(--sage-dark);cursor:pointer;font-size:11px;text-decoration:underline;padding:0;font-family:'DM Sans',sans-serif;}
  .auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
  .auth-box{background:var(--white);border-radius:16px;max-width:440px;width:100%;padding:48px;box-shadow:0 20px 60px rgba(0,0,0,0.1);border:1px solid var(--border);}
  .auth-logo{text-align:center;margin-bottom:32px;}
  .auth-logo svg{width:72px;height:72px;margin-bottom:20px;}
  .auth-logo h1{font-size:32px;font-weight:700;margin-bottom:6px;letter-spacing:-0.5px;}
  .auth-logo p{color:var(--warm-gray);font-size:13px;text-transform:uppercase;letter-spacing:1.8px;font-weight:600;}
  .auth-tabs{display:flex;gap:8px;margin-bottom:28px;border-bottom:1px solid var(--border);}
  .auth-tab{flex:1;background:none;border:none;padding:12px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--warm-gray);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
  .auth-tab.active{color:var(--sage-dark);border-bottom-color:var(--sage);font-weight:600;}
  .auth-form{display:none;}.auth-form.active{display:block;}
  .tab-bar{background:var(--white);border-bottom:1px solid var(--border);display:flex;padding:0 40px;}
  .tab-btn{font-family:'DM Sans',sans-serif;background:none;border:none;padding:14px 24px;font-size:14px;font-weight:500;color:var(--warm-gray);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;display:flex;align-items:center;gap:8px;}
  .tab-btn:hover{color:var(--charcoal);}
  .tab-btn.active{color:var(--sage-dark);border-bottom-color:var(--sage);font-weight:600;}
  .tab-btn .count{background:var(--sage-pale);color:var(--sage-dark);font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;min-width:22px;text-align:center;}
  .tab-content{display:none;}.tab-content.active{display:block;}
  .main{max-width:820px;margin:0 auto;padding:40px 24px 80px;}
  .intro{text-align:center;margin-bottom:40px;}
  .intro h2{font-size:32px;font-weight:700;margin-bottom:8px;letter-spacing:-0.5px;}
  .intro p{color:var(--warm-gray);font-size:15px;max-width:520px;margin:0 auto;}
  .form-card{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:24px;}
  .form-section-header{background:var(--sage-pale);padding:16px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
  .section-number{width:28px;height:28px;background:var(--sage);color:var(--white);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0;}
  .form-section-header h3{font-size:18px;font-weight:600;}
  .form-body{padding:28px;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
  .form-grid .full-width{grid-column:1/-1;}
  .form-group{display:flex;flex-direction:column;gap:6px;}
  .form-group label{font-size:13px;font-weight:600;letter-spacing:0.2px;}
  .form-group label .required{color:var(--error);margin-left:2px;}
  .form-group label .hint{font-weight:400;color:var(--warm-gray);font-size:12px;margin-left:4px;}
  input,select,textarea{font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--cream);color:var(--charcoal);transition:all 0.2s ease;outline:none;}
  input:focus,select:focus,textarea:focus{border-color:var(--sage);background:var(--white);box-shadow:0 0 0 3px rgba(143,175,143,0.15);}
  textarea{resize:vertical;min-height:80px;}
  select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B6B6B' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;}
  .fee-toggle{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;}
  .fee-toggle label{flex:1;text-align:center;padding:10px 12px;font-size:12px;font-weight:500;cursor:pointer;background:var(--cream);color:var(--warm-gray);border-right:1px solid var(--border);transition:all 0.2s;}
  .fee-toggle label:last-child{border-right:none;}
  .fee-toggle input{display:none;}
  .fee-toggle input:checked+label,.fee-toggle label.active{background:var(--sage);color:var(--white);font-weight:600;}
  .conditional-field{display:none;animation:slideDown 0.3s ease;}
  .conditional-field.visible{display:flex;}
  @keyframes slideDown{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
  .specialist-fields{display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
  .specialist-fields.visible{display:block;}
  .actions{display:flex;gap:16px;margin-top:32px;justify-content:center;flex-wrap:wrap;}
  .btn{font-family:'DM Sans',sans-serif;padding:14px 32px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.25s ease;display:flex;align-items:center;gap:8px;letter-spacing:0.3px;}
  .btn:disabled{opacity:0.5;cursor:not-allowed;}
  .btn-primary{background:var(--sage);color:var(--white);}
  .btn-primary:hover:not(:disabled){background:var(--sage-dark);transform:translateY(-1px);box-shadow:0 4px 16px rgba(107,143,107,0.3);}
  .btn-secondary{background:var(--white);color:var(--charcoal);border:1px solid var(--border);}
  .btn-secondary:hover:not(:disabled){background:var(--light-gray);transform:translateY(-1px);}
  .btn-danger{background:var(--white);color:var(--error);border:1px solid #ECC;}
  .btn-danger:hover:not(:disabled){background:#FFF5F5;}
  .btn-sm{padding:8px 16px;font-size:12px;border-radius:6px;}
  .btn svg{width:16px;height:16px;}
  .btn-full{width:100%;justify-content:center;}
  .dashboard{max-width:1100px;margin:0 auto;padding:40px 24px 80px;}
  .dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px;flex-wrap:wrap;gap:16px;}
  .dash-header h2{font-size:28px;font-weight:700;letter-spacing:-0.5px;}
  .dash-actions{display:flex;gap:10px;flex-wrap:wrap;}
  .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:28px;}
  .stat-card{background:var(--white);border:1px solid var(--border);border-radius:10px;padding:20px;text-align:center;}
  .stat-card .stat-num{font-size:36px;font-weight:700;color:var(--sage-dark);line-height:1;}
  .stat-card .stat-label{font-size:12px;color:var(--warm-gray);text-transform:uppercase;letter-spacing:1px;margin-top:6px;font-weight:500;}
  .stat-card.stat-alert{border-color:#E67E22;background:#FEF5E7;}.stat-card.stat-alert .stat-num{color:#E67E22;}
  .tracker-table-wrap{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .tracker-table{width:100%;border-collapse:collapse;font-size:13px;}
  .tracker-table thead{background:var(--sage-pale);}
  .tracker-table th{padding:12px 16px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.8px;color:var(--sage-dark);border-bottom:1px solid var(--border);white-space:nowrap;}
  .tracker-table td{padding:12px 16px;border-bottom:1px solid var(--border);vertical-align:middle;}
  .tracker-table tr:last-child td{border-bottom:none;}
  .tracker-table tr:hover td{background:var(--sage-pale);}
  .status-pill{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;letter-spacing:0.3px;text-transform:uppercase;white-space:nowrap;}
  .status-prospective{background:var(--amber-pale);color:#9A7B00;}
  .status-sent{background:#E3F2FD;color:#1565C0;}
  .status-executed{background:var(--sage-pale);color:var(--sage-dark);}
  .status-declined{background:#FBEAEA;color:var(--error);}
  .empty-state{text-align:center;padding:60px 24px;color:var(--warm-gray);}
  .empty-state p{font-size:15px;}
  .row-actions{display:flex;gap:6px;}
  .row-actions select{padding:5px 8px;font-size:11px;border-radius:6px;background:var(--cream);min-width:110px;}
  .row-actions button{background:none;border:1px solid var(--border);border-radius:6px;padding:5px 8px;cursor:pointer;color:var(--warm-gray);font-size:11px;transition:all 0.2s;}
  .row-actions button:hover{color:var(--charcoal);background:var(--light-gray);}
  .row-actions button.del:hover{color:var(--error);background:#FFF5F5;border-color:#ECC;}
  .status-bar{position:fixed;bottom:0;left:0;right:0;background:var(--charcoal);color:var(--white);padding:14px 24px;display:flex;align-items:center;justify-content:center;gap:10px;font-size:13px;font-weight:500;transform:translateY(100%);transition:transform 0.3s ease;z-index:100;}
  .status-bar.visible{transform:translateY(0);}
  .status-bar.success{background:var(--sage-dark);}
  .status-bar.error{background:var(--error);}
  .loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .help-text{font-size:12px;color:var(--warm-gray);margin-top:8px;}
  /* Review/Edit Engagement Letter Modal */
  .letter-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:center;justify-content:center;padding:24px;}
  .letter-modal-overlay.visible{display:flex;}
  .letter-modal{background:var(--white);border-radius:16px;max-width:900px;width:100%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.2);overflow:hidden;}
  .letter-modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid var(--border);background:var(--sage-pale);flex-shrink:0;}
  .letter-modal-header h2{font-size:20px;font-weight:700;color:var(--charcoal);display:flex;align-items:center;gap:10px;}
  .letter-modal-header .modal-actions{display:flex;gap:10px;}
  .letter-modal-body{overflow-y:auto;padding:28px;flex:1;}
  .letter-section{margin-bottom:24px;border:1px solid var(--border);border-radius:10px;overflow:hidden;}
  .letter-section-header{background:var(--light-gray);padding:10px 16px;font-size:13px;font-weight:600;color:var(--sage-dark);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
  .letter-section-header svg{width:14px;height:14px;opacity:0.6;}
  .letter-section textarea{width:100%;border:none;padding:14px 16px;font-family:'DM Sans',sans-serif;font-size:13.5px;line-height:1.7;color:var(--charcoal);resize:vertical;min-height:60px;background:var(--white);outline:none;}
  .letter-section textarea:focus{background:var(--cream);}
  .letter-section textarea.tall{min-height:140px;}
  .letter-section textarea.short{min-height:40px;}
  .editor-toolbar{display:flex;gap:2px;padding:6px 16px;border-bottom:1px solid var(--border);background:var(--light-gray);}
  .editor-toolbar button{width:28px;height:28px;border:1px solid var(--border);border-radius:4px;background:var(--white);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;color:var(--charcoal);font-family:serif;line-height:1;}
  .editor-toolbar button:hover{background:var(--sage-pale);border-color:var(--sage);}
  .rich-editor{width:100%;border:none;padding:14px 16px;font-family:'DM Sans',sans-serif;font-size:13.5px;line-height:1.7;color:var(--charcoal);min-height:60px;background:var(--white);outline:none;overflow-y:auto;white-space:pre-wrap;box-sizing:border-box;}
  .rich-editor:focus{background:var(--cream);}
  .rich-editor.tall{min-height:140px;}
  .letter-section-row{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);}
  .letter-section-row:last-child{border-bottom:none;}
  .letter-section-field{padding:10px 16px;display:flex;flex-direction:column;gap:4px;}
  .letter-section-field:first-child{border-right:1px solid var(--border);}
  .letter-section-field label{font-size:11px;font-weight:600;color:var(--warm-gray);text-transform:uppercase;letter-spacing:0.5px;}
  .letter-section-field input{border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px;font-family:'DM Sans',sans-serif;background:var(--cream);}
  .letter-section-field input:focus{border-color:var(--sage);background:var(--white);outline:none;box-shadow:0 0 0 2px rgba(143,175,143,0.15);}
  .letter-modal-footer{padding:16px 28px;border-top:1px solid var(--border);background:var(--light-gray);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
  .letter-modal-footer .hint{font-size:12px;color:var(--warm-gray);}

  /* Document History Modal */
  .doc-history-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:250;display:none;align-items:center;justify-content:center;padding:24px;}
  .doc-history-overlay.visible{display:flex;}
  .doc-history-panel{background:var(--white);border-radius:16px;max-width:640px;width:100%;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.2);overflow:hidden;}
  .doc-history-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid var(--border);background:var(--sage-pale);flex-shrink:0;}
  .doc-history-header h2{font-size:18px;font-weight:700;color:var(--charcoal);display:flex;align-items:center;gap:10px;}
  .doc-history-body{overflow-y:auto;padding:20px 28px;flex:1;}
  .doc-version-card{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border:1px solid var(--border);border-radius:10px;margin-bottom:10px;transition:background 0.15s;}
  .doc-version-card:hover{background:var(--sage-pale);}
  .doc-version-info{display:flex;align-items:center;gap:12px;min-width:0;}
  .doc-version-badge{background:var(--sage);color:var(--white);font-size:11px;font-weight:700;padding:4px 10px;border-radius:6px;white-space:nowrap;letter-spacing:0.3px;}
  .doc-version-name{font-size:13px;font-weight:600;color:var(--charcoal);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:280px;}
  .doc-version-detail{font-size:11px;color:var(--warm-gray);margin-top:2px;}
  .doc-version-actions{display:flex;gap:6px;flex-shrink:0;}
  .doc-saved-banner{background:var(--amber-pale);border:1px solid #E6D990;border-radius:8px;padding:10px 16px;margin-bottom:20px;font-size:12px;font-weight:500;color:#7A6800;display:flex;align-items:center;gap:8px;}

  /* Edit Client Modal */
  .edit-client-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:260;display:none;align-items:center;justify-content:center;padding:24px;}
  .edit-client-overlay.visible{display:flex;}
  .edit-client-panel{background:var(--white);border-radius:16px;max-width:860px;width:100%;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,0.2);overflow:hidden;}
  .edit-client-header{display:flex;align-items:center;justify-content:space-between;padding:20px 28px;border-bottom:1px solid var(--border);background:var(--sage-pale);flex-shrink:0;}
  .edit-client-header h2{font-size:18px;font-weight:700;color:var(--charcoal);display:flex;align-items:center;gap:10px;}
  .edit-client-body{overflow-y:auto;padding:24px 28px;flex:1;}
  .edit-warning-box{background:#FFF3E0;border:1px solid #FFB74D;border-radius:10px;padding:16px 20px;margin-bottom:24px;display:flex;align-items:flex-start;gap:12px;}
  .edit-warning-box svg{flex-shrink:0;color:#E65100;margin-top:1px;}
  .edit-warning-box .edit-warning-text{font-size:13px;color:#BF360C;line-height:1.5;}
  .edit-warning-box .edit-warning-text strong{display:block;font-size:14px;margin-bottom:4px;color:#E65100;}
  .edit-ack-row{margin-top:10px;display:flex;align-items:center;gap:8px;}
  .edit-ack-row input[type="checkbox"]{width:16px;height:16px;accent-color:#E65100;cursor:pointer;}
  .edit-ack-row label{font-size:12px;font-weight:600;color:#BF360C;cursor:pointer;}
  .edit-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px 20px;}
  .edit-form-grid .full-width{grid-column:1/-1;}
  .edit-form-grid label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--warm-gray);margin-bottom:4px;}
  .edit-form-grid input,.edit-form-grid select,.edit-form-grid textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;transition:border-color 0.2s;}
  .edit-form-grid input:focus,.edit-form-grid select:focus,.edit-form-grid textarea:focus{border-color:var(--sage);outline:none;box-shadow:0 0 0 3px rgba(143,175,143,0.15);}
  .edit-form-grid textarea{min-height:60px;resize:vertical;}
  .edit-section-label{grid-column:1/-1;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;color:var(--sage-dark);padding:12px 0 4px;border-bottom:1px solid var(--border);margin-top:8px;}
  .edit-fee-toggle{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:4px;}
  .edit-fee-toggle label{flex:1;text-align:center;padding:8px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;background:var(--white);color:var(--warm-gray);border-right:1px solid var(--border);}
  .edit-fee-toggle label:last-child{border-right:none;}
  .edit-fee-toggle input{display:none;}
  .edit-fee-toggle input:checked+label,.edit-fee-toggle label.active{background:var(--sage);color:var(--white);}
  .edit-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border);}
  .edit-actions .btn{min-width:140px;}
  .btn-save-edit{background:#E65100;color:#fff;border:none;}
  .btn-save-edit:hover:not(:disabled){background:#BF360C;transform:translateY(-1px);box-shadow:0 4px 16px rgba(230,81,0,0.3);}
  .btn-save-edit:disabled{background:#FFAB91;cursor:not-allowed;}

  .header-config-btn{display:flex;align-items:center;gap:6px;background:var(--cream);border:1px dashed var(--sage);border-radius:20px;padding:6px 14px;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--sage-dark);cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.5px;}
  .header-config-btn:hover{background:var(--sage-pale);border-style:solid;}
  .header-config-btn.active{border-style:solid;background:var(--sage-pale);}
  .header-config-btn img{height:20px;width:auto;border-radius:3px;}
  .btn-slack{background:#4A154B;color:#fff;border:none;}
  .btn-slack:hover:not(:disabled){background:#611f69;transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,21,75,0.3);}
  .btn-slack:disabled{background:#4A154B;}
  .btn-send-email{background:#2980B9;color:#fff;border:none;}
  .btn-send-email:hover:not(:disabled){background:#2471a3;transform:translateY(-1px);box-shadow:0 4px 16px rgba(41,128,185,0.3);}
  .btn-send-email:disabled{background:#2980B9;}
  .email-compose-panel{background:var(--cream);border:1px solid var(--border);border-radius:10px;margin-bottom:20px;overflow:hidden;display:none;}
  .email-compose-panel.visible{display:block;}
  .email-compose-header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:var(--sage-pale);border-bottom:1px solid var(--border);}
  .email-compose-header h3{font-size:14px;font-weight:600;color:var(--charcoal);display:flex;align-items:center;gap:8px;}
  .email-compose-header .close-compose{background:none;border:none;font-size:18px;cursor:pointer;color:var(--warm-gray);padding:0 4px;line-height:1;}
  .email-compose-header .close-compose:hover{color:var(--charcoal);}
  .email-compose-body{padding:18px;}
  .email-compose-body .email-field{margin-bottom:14px;}
  .email-compose-body .email-field label{display:block;font-size:12px;font-weight:600;color:var(--dark);margin-bottom:4px;}
  .email-compose-body .email-field input,.email-compose-body .email-field textarea{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;font-family:inherit;font-size:13px;background:var(--white);box-sizing:border-box;}
  .email-compose-body .email-field input:focus,.email-compose-body .email-field textarea:focus{border-color:var(--navy);outline:none;box-shadow:0 0 0 2px rgba(44,62,80,0.12);}
  .email-compose-body .email-field textarea{resize:vertical;min-height:120px;line-height:1.5;}
  .email-compose-body .email-field-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
  .email-compose-footer{display:flex;justify-content:flex-end;gap:10px;padding:0 18px 18px;}
  .email-sent-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:4px 10px;border-radius:10px;background:#E8F5E9;color:#2E7D32;white-space:nowrap;}

  /* Assignment & Approval Workflow */
  .dash-filters{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;}
  .dash-filter-btn{font-family:'DM Sans',sans-serif;background:var(--white);border:1px solid var(--border);border-radius:20px;padding:7px 16px;font-size:12px;font-weight:500;color:var(--warm-gray);cursor:pointer;transition:all 0.2s;}
  .dash-filter-btn:hover{color:var(--charcoal);border-color:var(--sage);}
  .dash-filter-btn.active{background:var(--sage);color:var(--white);border-color:var(--sage);font-weight:600;}
  .assigned-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:500;padding:3px 10px;border-radius:10px;white-space:nowrap;}
  .assigned-badge.has-assignee{background:#E3F2FD;color:#1565C0;}
  .assigned-badge.no-assignee{background:var(--light-gray);color:var(--warm-gray);}
  .approval-pill{display:inline-block;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:600;letter-spacing:0.3px;text-transform:uppercase;white-space:nowrap;}
  .approval-draft{background:var(--light-gray);color:var(--warm-gray);}
  .approval-pending{background:var(--amber-pale);color:#9A7B00;}
  .approval-approved{background:var(--sage-pale);color:var(--sage-dark);}
  .approval-changes{background:#FBEAEA;color:var(--error);}
  .approval-executed{background:#E8F5E9;color:#2E7D32;}
  .approval-bar{display:flex;flex-direction:column;gap:12px;padding:16px 18px;border:1px solid var(--border);border-radius:10px;margin-bottom:20px;}
  .approval-bar .approval-top-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  .approval-bar.bar-draft{background:var(--light-gray);border-color:var(--border);}
  .approval-bar.bar-pending{background:var(--amber-pale);border-color:#E6D990;}
  .approval-bar.bar-approved{background:var(--sage-pale);border-color:var(--sage-light);}
  .approval-bar.bar-changes{background:#FBEAEA;border-color:#ECC;}
  .approval-bar.bar-executed{background:#E8F5E9;border-color:#A5D6A7;}
  .approval-bar .approval-status-text{font-size:13px;font-weight:600;flex:1;}
  .approval-bar .approval-status-text small{font-weight:400;color:var(--warm-gray);display:block;font-size:11px;margin-top:2px;}
  .approval-bar .approval-actions{display:flex;gap:8px;flex-shrink:0;}
  .approval-bar .reviewer-row{display:flex;align-items:center;gap:10px;padding-top:4px;}
  .approval-bar .reviewer-row label{font-size:12px;font-weight:600;color:var(--dark);white-space:nowrap;}
  .approval-bar .reviewer-select{padding:7px 12px;border-radius:8px;border:1px solid var(--border);font-size:13px;font-family:inherit;background:#fff;min-width:200px;cursor:pointer;}
  .approval-bar .reviewer-select:focus{border-color:var(--navy);outline:none;box-shadow:0 0 0 2px rgba(44,62,80,0.12);}
  .btn-approve{background:#27AE60;color:#fff;border:none;}
  .btn-approve:hover:not(:disabled){background:#219a52;transform:translateY(-1px);box-shadow:0 4px 16px rgba(39,174,96,0.3);}
  .btn-send-back{background:#C0392B;color:#fff;border:none;}
  .btn-send-back:hover:not(:disabled){background:#a93226;transform:translateY(-1px);box-shadow:0 4px 16px rgba(192,57,43,0.3);}
  .btn-submit-review{background:#2980B9;color:#fff;border:none;}
  .btn-submit-review:hover:not(:disabled){background:#2471a3;transform:translateY(-1px);box-shadow:0 4px 16px rgba(41,128,185,0.3);}
  .review-notes-box{background:var(--amber-pale);border:1px solid #E6D990;border-radius:8px;padding:12px 16px;margin-bottom:16px;font-size:13px;line-height:1.5;}
  .review-notes-box strong{display:block;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:#9A7B00;margin-bottom:4px;}

  /* Settings Tab */
  .settings{max-width:680px;margin:0 auto;padding:40px 24px 80px;}
  .settings-header{margin-bottom:32px;}
  .settings-header h2{font-size:28px;font-weight:700;letter-spacing:-0.5px;margin-bottom:4px;}
  .settings-header p{color:var(--warm-gray);font-size:14px;}
  .settings-card{background:var(--white);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:20px;}
  .settings-card-header{background:var(--sage-pale);padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
  .settings-card-header h3{font-size:16px;font-weight:600;color:var(--charcoal);}
  .settings-card-header svg{opacity:0.6;}
  .settings-card-body{padding:24px;}
  .settings-card-body p{font-size:13px;color:var(--warm-gray);margin-bottom:16px;line-height:1.6;}
  .settings-row{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 0;border-bottom:1px solid var(--border);}
  .settings-row:last-child{border-bottom:none;padding-bottom:0;}
  .settings-row:first-child{padding-top:0;}
  .settings-row-label{display:flex;flex-direction:column;gap:2px;flex:1;min-width:0;}
  .settings-row-label strong{font-size:14px;font-weight:600;}
  .settings-row-label span{font-size:12px;color:var(--warm-gray);}
  .settings-row-action{flex-shrink:0;}
  .logo-preview-box{display:flex;align-items:center;gap:16px;padding:12px 16px;background:var(--cream);border:1px solid var(--border);border-radius:8px;margin-top:12px;}
  .logo-preview-box img{height:40px;width:auto;border-radius:4px;border:1px solid var(--border);}
  .logo-preview-box .remove-link{font-size:12px;color:var(--error);cursor:pointer;text-decoration:underline;margin-left:auto;}
  .toggle-switch{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;}
  .toggle-switch input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);border-radius:24px;transition:0.2s;}
  .toggle-slider:before{content:'';position:absolute;height:18px;width:18px;left:3px;bottom:3px;background:var(--white);border-radius:50%;transition:0.2s;}
  .toggle-switch input:checked+.toggle-slider{background:var(--sage);}
  .toggle-switch input:checked+.toggle-slider:before{transform:translateX(20px);}

  @media(max-width:640px){
    .form-grid{grid-template-columns:1fr;}.header{padding:16px 20px;flex-direction:column;gap:12px;}
    .tab-bar{padding:0 16px;}.tab-btn{padding:12px 16px;font-size:13px;}
    .actions{flex-direction:column;}.btn{justify-content:center;}
    .dashboard{padding:24px 16px;}.tracker-table-wrap{overflow-x:auto;}.auth-box{padding:32px 24px;}.settings{padding:24px 16px;}
  }
</style>
</head>
<body>

<div class="auth-container" id="authContainer">
  <div class="auth-box">
    <div class="auth-logo">
      <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="ag" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#8FAF8F" /><stop offset="100%" style="stop-color:#6B8F6B" /></linearGradient></defs>
        <path d="M50 30 L130 30 L130 50 L150 70 L150 170 L50 170 Z" fill="url(#ag)" opacity="0.15"/>
        <path d="M130 30 L130 50 L150 70 Z" fill="url(#ag)" opacity="0.25"/>
        <path d="M50 30 L130 30 L130 50 L150 70 L150 170 L50 170 Z" fill="none" stroke="url(#ag)" stroke-width="3" stroke-linejoin="round"/>
        <path d="M130 30 L130 50 L150 70" fill="none" stroke="url(#ag)" stroke-width="3" stroke-linejoin="round"/>
        <path d="M75 90 L90 105 L125 70" fill="none" stroke="url(#ag)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="70" y1="130" x2="130" y2="130" stroke="url(#ag)" stroke-width="3" stroke-linecap="round" opacity="0.6"/>
        <line x1="70" y1="145" x2="115" y2="145" stroke="url(#ag)" stroke-width="3" stroke-linecap="round" opacity="0.4"/>
      </svg>
      <h1>Intakr</h1><p>Client Intake System</p>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>
    <div class="auth-form active" id="loginForm">
      <div class="form-group"><label>Email</label><input type="email" id="loginEmail" placeholder="your@margolispllc.com"></div>
      <div class="form-group" style="margin-top:16px"><label>Password</label><input type="password" id="loginPassword" placeholder="••••••••" onkeydown="if(event.key==='Enter')handleLogin()"></div>
      <button class="btn btn-primary btn-full" onclick="handleLogin()" id="loginBtn" style="margin-top:24px">Sign In</button>
      <p class="help-text" style="text-align:center;margin-top:16px"><button onclick="switchAuthTab('reset')" style="background:none;border:none;color:var(--sage-dark);text-decoration:underline;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px">Forgot password?</button></p>
      <p class="help-text" style="text-align:center;margin-top:8px">First time? Click "Sign Up" above.</p>
    </div>
    <div class="auth-form" id="signupForm">
      <div class="form-group"><label>Full Name</label><input type="text" id="signupName" placeholder="John Doe"></div>
      <div class="form-group" style="margin-top:16px"><label>Email</label><input type="email" id="signupEmail" placeholder="yourname@margolispllc.com"><p class="help-text">Must be a @margolispllc.com email</p></div>
      <div class="form-group" style="margin-top:16px"><label>Password</label><input type="password" id="signupPassword" placeholder="••••••••" onkeydown="if(event.key==='Enter')handleSignup()"><p class="help-text">At least 6 characters</p></div>
      <button class="btn btn-primary btn-full" onclick="handleSignup()" id="signupBtn" style="margin-top:24px">Create Account</button>
    </div>
    <div class="auth-form" id="resetForm">
      <p style="color:var(--warm-gray);margin-bottom:24px;text-align:center;font-size:14px">Enter your email and we'll send a reset link.</p>
      <div class="form-group"><label>Email</label><input type="email" id="resetEmail" placeholder="your@margolispllc.com" onkeydown="if(event.key==='Enter')handlePasswordReset()"></div>
      <button class="btn btn-primary btn-full" onclick="handlePasswordReset()" id="resetBtn" style="margin-top:24px">Send Reset Link</button>
      <p class="help-text" style="text-align:center;margin-top:16px"><button onclick="switchAuthTab('login')" style="background:none;border:none;color:var(--sage-dark);text-decoration:underline;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px">Back to Sign In</button></p>
    </div>
    <div class="auth-form" id="updatePasswordForm">
      <p style="color:var(--warm-gray);margin-bottom:24px;text-align:center;font-size:14px">Enter your new password below.</p>
      <div class="form-group"><label>New Password</label><input type="password" id="newPassword" placeholder="••••••••"><p class="help-text">At least 6 characters</p></div>
      <div class="form-group" style="margin-top:16px"><label>Confirm Password</label><input type="password" id="confirmPassword" placeholder="••••••••" onkeydown="if(event.key==='Enter')handleUpdatePassword()"></div>
      <button class="btn btn-primary btn-full" onclick="handleUpdatePassword()" id="updatePasswordBtn" style="margin-top:24px">Update Password</button>
    </div>
  </div>
</div>

<div class="app-container" id="appContainer">
<div class="header">
  <div class="header-left">
    <svg class="header-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="lg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#8FAF8F" /><stop offset="100%" style="stop-color:#6B8F6B" /></linearGradient></defs>
      <path d="M50 30 L130 30 L130 50 L150 70 L150 170 L50 170 Z" fill="url(#lg)" opacity="0.15"/>
      <path d="M130 30 L130 50 L150 70 Z" fill="url(#lg)" opacity="0.25"/>
      <path d="M50 30 L130 30 L130 50 L150 70 L150 170 L50 170 Z" fill="none" stroke="url(#lg)" stroke-width="3" stroke-linejoin="round"/>
      <path d="M130 30 L130 50 L150 70" fill="none" stroke="url(#lg)" stroke-width="3" stroke-linejoin="round"/>
      <path d="M75 90 L90 105 L125 70" fill="none" stroke="url(#lg)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
      <line x1="70" y1="130" x2="130" y2="130" stroke="url(#lg)" stroke-width="3" stroke-linecap="round" opacity="0.6"/>
      <line x1="70" y1="145" x2="115" y2="145" stroke="url(#lg)" stroke-width="3" stroke-linecap="round" opacity="0.4"/>
    </svg>
    <div class="header-divider"></div>
    <div class="header-text"><h1>Intakr</h1><p>By Margolis PLLC</p></div>
  </div>
  <div class="header-right">
    <div class="header-badge">Secure</div>
    <div class="user-menu"><span id="userEmail"></span><button onclick="handleLogout()">Sign Out</button></div>
  </div>
</div>
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('intake',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg> New Intake</button>
  <button class="tab-btn" onclick="switchTab('dashboard',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg> Client Tracker <span class="count" id="trackerCount">0</span></button>
  <button class="tab-btn" onclick="switchTab('settings',this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg> Settings</button>
</div>

<div class="tab-content active" id="tab-intake">
<div class="main">
  <div class="intro"><h2>New Matter Intake</h2><p>Complete this form to generate the engagement letter and add the matter to the master tracker.</p></div>
  <form id="intakeForm" novalidate>
    <div class="form-card">
      <div class="form-section-header"><div class="section-number">1</div><h3>Client Information</h3></div>
      <div class="form-body"><div class="form-grid">
        <div class="form-group"><label>Client Type <span class="required">*</span></label><select id="clientType" required><option value="">Select…</option><option value="Individual">Individual</option><option value="Business Entity">Business Entity</option></select></div>
        <div class="form-group"><label>Entity Name <span class="hint">(if business)</span></label><input type="text" id="entityName" placeholder="e.g., Acme Holdings LLC"></div>
        <div class="form-group"><label>Contact Full Name <span class="required">*</span></label><input type="text" id="contactName" placeholder="First and Last Name" required></div>
        <div class="form-group"><label>Title / Role <span class="hint">(if business)</span></label><input type="text" id="contactTitle" placeholder="e.g., CEO, Managing Member"></div>
        <div class="form-group"><label>Email <span class="required">*</span></label><input type="email" id="clientEmail" placeholder="email@example.com" required></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="clientPhone" placeholder="(555) 555-5555"></div>
        <div class="form-group full-width"><label>Mailing Address</label><input type="text" id="clientAddress" placeholder="Street, City, State ZIP"></div>
      </div></div>
    </div>
    <div class="form-card">
      <div class="form-section-header"><div class="section-number">2</div><h3>Matter Details</h3></div>
      <div class="form-body"><div class="form-grid">
        <div class="form-group"><label>Matter Type <span class="required">*</span></label><select id="matterType" required><option value="">Select…</option><option value="Corporate/Business Formation">Corporate / Business Formation</option><option value="Commercial Litigation">Commercial Litigation</option><option value="Real Estate">Real Estate</option><option value="Employment">Employment</option><option value="Intellectual Property">Intellectual Property</option><option value="Contract Drafting/Review">Contract Drafting / Review</option><option value="Regulatory/Compliance">Regulatory / Compliance</option><option value="M&A/Transactions">M&A / Transactions</option><option value="Fractional General Counsel">Fractional General Counsel</option><option value="Fractional Corporate Counsel">Fractional Corporate Counsel</option><option value="Other">Other</option></select></div>
        <div class="form-group"><label>Attorney in Charge <span class="required">*</span></label><select id="attorney" required><option value="">Select…</option><option value="Matt A. Margolis, Esq.">Matt A. Margolis, Esq.</option><option value="Karina Margolis, Esq.">Karina Margolis, Esq.</option><option value="Jen Healy, Esq.">Jen Healy, Esq.</option><option value="Hunter Sutherland, Esq.">Hunter Sutherland, Esq.</option></select></div>
        <div class="form-group"><label>Assign To <span class="hint">(optional)</span></label><select id="assignTo"><option value="">Not assigned</option><option value="Matt A. Margolis, Esq.">Matt A. Margolis, Esq.</option><option value="Karina Margolis, Esq.">Karina Margolis, Esq.</option><option value="Jen Healy, Esq.">Jen Healy, Esq.</option><option value="Hunter Sutherland, Esq.">Hunter Sutherland, Esq.</option></select></div>
        <div class="form-group full-width"><label>Matter Description <span class="required">*</span></label><textarea id="matterDescription" placeholder="Brief description of the matter…" required></textarea></div>
        <div class="form-group full-width"><label>Adverse / Opposing Party <span class="hint">(if any)</span></label><input type="text" id="adverseParty" placeholder="Name of opposing party or N/A"></div>
      </div></div>
    </div>
    <div class="form-card">
      <div class="form-section-header"><div class="section-number">3</div><h3>Fee Structure</h3></div>
      <div class="form-body"><div class="form-grid">
        <div class="form-group full-width"><label>Fee Type <span class="required">*</span></label>
          <div class="fee-toggle">
            <input type="radio" name="feeType" id="feeHourly" value="Hourly" checked><label for="feeHourly" class="active">Hourly</label>
            <input type="radio" name="feeType" id="feeFlat" value="Flat Fee"><label for="feeFlat">Flat Fee</label>
            <input type="radio" name="feeType" id="feeHybrid" value="Hybrid"><label for="feeHybrid">Hybrid</label>
            <input type="radio" name="feeType" id="feeSub" value="Subscription"><label for="feeSub">Subscription</label>
          </div>
        </div>
        <div class="form-group conditional-field visible" id="hourlyRateGroup"><label>Attorney Hourly Rate</label><input type="text" id="hourlyRate" value="$500.00"></div>
        <div class="form-group conditional-field visible" id="paralegalRateGroup"><label>Paralegal Hourly Rate</label><input type="text" id="paralegalRate" value="$225.00"></div>
        <div class="form-group conditional-field" id="flatFeeGroup"><label>Flat Fee Amount</label><input type="text" id="flatFeeAmount" placeholder="e.g., $5,000.00"></div>
        <div class="form-group conditional-field" id="monthlyFeeGroup"><label>Monthly Subscription Fee</label><input type="text" id="monthlyFee" placeholder="e.g., $2,500.00/month"></div>
        <div class="form-group"><label>Retainer Amount</label><input type="text" id="retainerAmount" placeholder="e.g., $5,000.00"></div>
        <div class="form-group"><label>Engagement Date <span class="required">*</span></label><input type="date" id="engagementDate" required></div>
      </div></div>
    </div>
    <div class="form-card">
      <div class="form-section-header"><div class="section-number">4</div><h3>Conflicts & Referral</h3></div>
      <div class="form-body"><div class="form-grid">
        <div class="form-group full-width"><label>Known Conflicts</label><textarea id="conflicts" placeholder="Describe any known or potential conflicts, or type 'None'"></textarea></div>
        <div class="form-group full-width"><label>Specialist or co-counsel involved?</label><select id="specialistInvolved"><option value="No">No</option><option value="Yes">Yes</option></select></div>
      </div>
      <div class="specialist-fields" id="specialistFields"><div class="form-grid">
        <div class="form-group"><label>Specialist Name</label><input type="text" id="specialistName" placeholder="Name"></div>
        <div class="form-group"><label>Fee-Sharing Arrangement</label><input type="text" id="feeSharingDetails" placeholder="Describe arrangement"></div>
      </div></div>
      </div>
    </div>
    <div class="form-card">
      <div class="form-section-header"><div class="section-number">5</div><h3>Internal Notes</h3></div>
      <div class="form-body"><div class="form-grid">
        <div class="form-group"><label>Referral Source</label><input type="text" id="referralSource" placeholder="How did they find us?"></div>
        <div class="form-group"><label>Priority</label><select id="priority"><option value="Normal">Normal</option><option value="High">High</option><option value="Urgent">Urgent</option></select></div>
        <div class="form-group full-width"><label>Internal Notes</label><textarea id="internalNotes" placeholder="Any additional notes…"></textarea></div>
      </div></div>
    </div>
    <div class="actions">
      <button type="button" class="btn btn-primary" onclick="generateAll()" id="generateBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg> Generate Letter + Add to Tracker</button>
      <button type="button" class="btn btn-secondary" onclick="addToTrackerOnly()" id="trackerBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg> Add to Tracker Only</button>
      <button type="reset" class="btn btn-secondary" onclick="resetForm()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg> Clear</button>
    </div>
  </form>
</div>
</div>

<div class="tab-content" id="tab-dashboard">
<div class="dashboard">
  <div class="dash-header"><h2>Client Tracker</h2>
    <div class="dash-actions">
      <button class="btn btn-secondary btn-sm" onclick="renderDashboard()">Refresh</button>
      <button class="btn btn-primary btn-sm" onclick="exportMasterExcel()">Export Excel</button>
      <button class="btn btn-danger btn-sm" onclick="clearAllData()">Clear All</button>
    </div>
  </div>
  <div class="dash-filters" id="dashFilters">
    <button class="dash-filter-btn active" onclick="setDashFilter('all',this)">All Matters</button>
    <button class="dash-filter-btn" onclick="setDashFilter('mine',this)">My Matters</button>
    <button class="dash-filter-btn" onclick="setDashFilter('assigned',this)">Assigned to Me</button>
    <button class="dash-filter-btn" onclick="setDashFilter('review',this)">Needs Review</button>
  </div>
  <div class="stats-row" id="statsRow"></div>
  <div class="tracker-table-wrap"><div id="trackerTableContainer"></div></div>
</div>
</div>

<div class="tab-content" id="tab-settings">
<div class="settings">
  <div class="settings-header">
    <h2>Settings</h2>
    <p>Configure firm-wide preferences. Changes are saved automatically and shared across all users.</p>
  </div>

  <!-- Firm Logo -->
  <div class="settings-card">
    <div class="settings-card-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
      <h3>Firm Logo</h3>
    </div>
    <div class="settings-card-body">
      <p>Upload your firm logo to include it in engagement letter headers. Accepts PNG or JPG, max 2 MB.</p>
      <div class="settings-row">
        <div class="settings-row-label">
          <strong>Engagement Letter Logo</strong>
          <span>Appears at the top of all generated .docx letters</span>
        </div>
        <div class="settings-row-action">
          <button class="btn btn-secondary btn-sm" onclick="document.getElementById('logoFileInput').click()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload Logo</button>
          <input type="file" id="logoFileInput" accept="image/png,image/jpeg" style="display:none" onchange="handleLogoUpload(event)">
        </div>
      </div>
      <div id="logoPreviewArea" style="display:none;">
        <div class="logo-preview-box">
          <img id="logoPreviewImg" src="" alt="Firm logo">
          <span>Current logo</span>
          <span class="remove-link" onclick="removeLogo()">Remove</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Slack Notifications -->
  <div class="settings-card">
    <div class="settings-card-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"/><path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"/><path d="M14 14.5c0-.83.67-1.5 1.5-1.5h5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5z"/><path d="M14 20.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5.67-1.5 1.5-1.5h1.5v1.5z"/><path d="M10 9.5C10 10.33 9.33 11 8.5 11h-5C2.67 11 2 10.33 2 9.5S2.67 8 3.5 8h5c.83 0 1.5.67 1.5 1.5z"/><path d="M10 3.5C10 2.67 10.67 2 11.5 2S13 2.67 13 3.5 12.33 5 11.5 5H10V3.5z"/></svg>
      <h3>Slack Notifications</h3>
    </div>
    <div class="settings-card-body">
      <p>When enabled, engagement letters can be sent to your firm's Slack channel. The webhook URL is configured server-side for security.</p>
      <div class="settings-row">
        <div class="settings-row-label">
          <strong>Enable Slack Notifications</strong>
          <span id="slackStatusText">Disabled</span>
        </div>
        <div class="settings-row-action">
          <label class="toggle-switch">
            <input type="checkbox" id="slackToggle" onchange="toggleSlack()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Email Delivery -->
  <div class="settings-card">
    <div class="settings-card-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
      <h3>Client Email Delivery</h3>
    </div>
    <div class="settings-card-body">
      <p>When enabled, engagement letters can be emailed directly to clients from the letter review modal. The email API key is configured server-side for security.</p>
      <div class="settings-row">
        <div class="settings-row-label">
          <strong>Enable Send to Client</strong>
          <span id="emailStatusText">Disabled</span>
        </div>
        <div class="settings-row-action">
          <label class="toggle-switch">
            <input type="checkbox" id="emailToggle" onchange="toggleEmail()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-row">
        <div class="settings-row-label">
          <strong>Reply-To Address</strong>
          <span>Clients will reply to this address (defaults to the sending attorney's email)</span>
        </div>
        <div class="settings-row-action">
          <input type="text" id="emailReplyTo" placeholder="e.g. info@margolispllc.com" style="padding:7px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;width:220px;" onchange="saveEmailReplyTo()">
        </div>
      </div>
    </div>
  </div>

  <!-- BoldSign E-Signature -->
  <div class="settings-card">
    <div class="settings-card-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
      <h3>BoldSign E-Signature</h3>
    </div>
    <div class="settings-card-body">
      <p>When enabled, engagement letters can be sent for electronic signature via BoldSign. Clients receive a signing link by email and can sign directly in their browser. The API key is configured server-side for security.</p>
      <div class="settings-row">
        <div class="settings-row-label">
          <strong>Enable E-Signature</strong>
          <span id="boldsignStatusText">Disabled</span>
        </div>
        <div class="settings-row-action">
          <label class="toggle-switch">
            <input type="checkbox" id="boldsignToggle" onchange="toggleBoldsign()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-row" style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px;">
        <div class="settings-row-label">
          <strong>Setup Instructions</strong>
          <span>After enabling, set <code style="background:var(--sage-pale);padding:1px 6px;border-radius:4px;font-size:12px;">BOLDSIGN_API_KEY</code> in your Supabase Edge Function secrets. Configure the webhook URL in your BoldSign dashboard to point to your <code style="background:var(--sage-pale);padding:1px 6px;border-radius:4px;font-size:12px;">boldsign-webhook</code> Edge Function.</span>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

</div>

<!-- Review/Edit Engagement Letter Modal -->
<div class="letter-modal-overlay" id="letterModal">
  <div class="letter-modal">
    <div class="letter-modal-header">
      <h2><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> Review Engagement Letter</h2>
      <div class="modal-actions">
        <button class="btn btn-secondary btn-sm" onclick="closeLetterModal()" style="font-size:18px;line-height:1;padding:4px 10px;min-width:0;" title="Close">&times;</button>
        <button class="btn btn-slack btn-sm slack-send-btn" id="slackSendBtn" onclick="sendToSlack()" style="display:none"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"/><path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"/><path d="M14 14.5c0-.83.67-1.5 1.5-1.5h5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5z"/><path d="M15.5 19H14v1.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"/><path d="M10 9.5C10 10.33 9.33 11 8.5 11h-5C2.67 11 2 10.33 2 9.5S2.67 8 3.5 8h5c.83 0 1.5.67 1.5 1.5z"/><path d="M8.5 5H10V3.5C10 2.67 9.33 2 8.5 2S7 2.67 7 3.5 7.67 5 8.5 5z"/></svg> Send to Slack</button>
        <button class="btn btn-send-email btn-sm email-send-btn" id="emailSendBtn" onclick="toggleEmailCompose()" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Send to Client</button>
        <button class="btn btn-sm boldsign-send-btn" id="boldsignSendBtn" onclick="toggleEsignCompose()" style="display:none;background:#6C5CE7;color:var(--white);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg> Send for E-Signature</button>
        <button class="btn btn-primary btn-sm" onclick="downloadFromReview()" id="modalDownloadBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download .docx</button>
      </div>
    </div>
    <div class="letter-modal-body" id="letterModalBody">
      <!-- Sections rendered dynamically -->
    </div>
    <div class="letter-modal-footer">
      <span class="hint">Edit sections above. Save draft, submit for review, or download.</span>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-secondary btn-sm" onclick="saveDraft()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Draft</button>
      </div>
    </div>
  </div>
</div>

<!-- Document History Modal -->
<div class="doc-history-overlay" id="docHistoryModal">
  <div class="doc-history-panel">
    <div class="doc-history-header">
      <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> <span id="docHistoryTitle">Document History</span></h2>
      <button class="btn btn-secondary btn-sm" onclick="closeDocHistoryModal()">Close</button>
    </div>
    <div class="doc-history-body" id="docHistoryBody"></div>
  </div>
</div>

<!-- Edit Client Modal -->
<div class="edit-client-overlay" id="editClientModal">
  <div class="edit-client-panel">
    <div class="edit-client-header">
      <h2><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit Matter</h2>
      <button class="btn btn-secondary btn-sm" onclick="closeEditClientModal()" style="font-size:18px;line-height:1;padding:4px 10px;min-width:0;">&times;</button>
    </div>
    <div class="edit-client-body" id="editClientBody"></div>
  </div>
</div>

<div class="status-bar" id="statusBar"><span id="statusText"></span></div>

<script>
const SUPABASE_URL='https://jflxkrlxlvhrntodywth.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpmbHhrcmx4bHZocm50b2R5d3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwODkxNDAsImV4cCI6MjA4NjY2NTE0MH0.jbeY9K4N6UOhbR8m9F0AOiUZJW7_p1ESY-7cssu5P2Y';
const db=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
let currentUser=null;
let _dashFilter='all';
let _letterApprovalStatus=null;
let _letterApprovalId=null;
let _letterAssignedReviewer=null;

db.auth.onAuthStateChange((event,session)=>{
  if(event==='SIGNED_OUT'||event==='TOKEN_REFRESHED'&&!session){
    currentUser=null;
    document.getElementById('authContainer').style.display='flex';
    document.getElementById('appContainer').classList.remove('visible');
    showStatus('Session expired \u2014 please sign in again.','error');
  }
});

function switchAuthTab(t){document.querySelectorAll('.auth-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.auth-form').forEach(x=>x.classList.remove('active'));if(t==='login'){document.querySelectorAll('.auth-tab')[0].classList.add('active');document.getElementById('loginForm').classList.add('active');}else if(t==='signup'){document.querySelectorAll('.auth-tab')[1].classList.add('active');document.getElementById('signupForm').classList.add('active');}else if(t==='reset'){document.getElementById('resetForm').classList.add('active');}else if(t==='update-password'){document.getElementById('updatePasswordForm').classList.add('active');}}

async function handleLogin(){const e=document.getElementById('loginEmail').value.trim().toLowerCase(),p=document.getElementById('loginPassword').value;if(!e||!p){showStatus('Please enter email and password','error');return;}if(!e.endsWith('@margolispllc.com')){showStatus('Access restricted to @margolispllc.com','error');return;}const b=document.getElementById('loginBtn');b.disabled=true;b.innerHTML='<div class="loading-spinner"></div> Signing In...';try{const{data,error}=await db.auth.signInWithPassword({email:e,password:p});if(error)throw error;currentUser=data.user;if(!currentUser.email.endsWith('@margolispllc.com')){await db.auth.signOut();throw new Error('Access restricted');}showApp();showStatus('\u2713 Welcome back!','success');}catch(x){showStatus('Login failed: '+x.message,'error');b.disabled=false;b.innerHTML='Sign In';}}

async function handleSignup(){const n=document.getElementById('signupName').value.trim(),e=document.getElementById('signupEmail').value.trim().toLowerCase(),p=document.getElementById('signupPassword').value;if(!n||!e||!p){showStatus('Please fill in all fields','error');return;}if(!e.endsWith('@margolispllc.com')){showStatus('Access restricted to @margolispllc.com','error');return;}if(p.length<6){showStatus('Password must be at least 6 characters','error');return;}const b=document.getElementById('signupBtn');b.disabled=true;b.innerHTML='<div class="loading-spinner"></div> Creating...';try{const{data,error}=await db.auth.signUp({email:e,password:p,options:{data:{full_name:n}}});if(error)throw error;if(data.user){if(data.user.identities&&data.user.identities.length===0){showStatus('Email already registered. Try signing in or resetting your password.','error');switchAuthTab('login');}else if(data.session){currentUser=data.user;showApp();showStatus('\u2713 Account created!','success');}else{showStatus('\u2713 Account created! Check your email for a confirmation link, then sign in.','success');switchAuthTab('login');}}}catch(x){showStatus('Signup failed: '+x.message,'error');}finally{b.disabled=false;b.innerHTML='Create Account';}}

async function handlePasswordReset(){const e=document.getElementById('resetEmail').value.trim().toLowerCase();if(!e){showStatus('Enter your email','error');return;}if(!e.endsWith('@margolispllc.com')){showStatus('Access restricted to @margolispllc.com','error');return;}const b=document.getElementById('resetBtn');b.disabled=true;b.innerHTML='<div class="loading-spinner"></div> Sending...';try{const{error}=await db.auth.resetPasswordForEmail(e,{redirectTo:window.location.origin+window.location.pathname});if(error)throw error;showStatus('\u2713 Reset link sent!','success');setTimeout(()=>switchAuthTab('login'),3000);}catch(x){showStatus('Error: '+x.message,'error');}finally{b.disabled=false;b.innerHTML='Send Reset Link';}}

async function handleUpdatePassword(){const n=document.getElementById('newPassword').value,c=document.getElementById('confirmPassword').value;if(!n||!c){showStatus('Fill in both fields','error');return;}if(n.length<6){showStatus('Min 6 characters','error');return;}if(n!==c){showStatus('Passwords do not match','error');return;}const b=document.getElementById('updatePasswordBtn');b.disabled=true;b.innerHTML='<div class="loading-spinner"></div> Updating...';try{const{error}=await db.auth.updateUser({password:n});if(error)throw error;showStatus('\u2713 Password updated!','success');showApp();}catch(x){showStatus('Error: '+x.message,'error');b.disabled=false;b.innerHTML='Update Password';}}

async function handleLogout(){try{await db.auth.signOut();currentUser=null;document.getElementById('authContainer').style.display='flex';document.getElementById('appContainer').classList.remove('visible');showStatus('Signed out','success');}catch(x){showStatus('Error: '+x.message,'error');}}

function showApp(){document.getElementById('authContainer').style.display='none';document.getElementById('appContainer').classList.add('visible');if(!currentUser.email.endsWith('@margolispllc.com')){handleLogout();return;}document.getElementById('userEmail').textContent=currentUser.email;updateTrackerCount();renderDashboard();loadFirmSettings();}

async function checkAuth(){const{data:{session}}=await db.auth.getSession();const hp=new URLSearchParams(window.location.hash.substring(1));if(hp.get('type')==='recovery'){if(session&&session.user){if(!session.user.email.endsWith('@margolispllc.com')){await db.auth.signOut();return;}currentUser=session.user;}switchAuthTab('update-password');return;}if(session){if(!session.user.email.endsWith('@margolispllc.com')){await db.auth.signOut();return;}currentUser=session.user;showApp();handleDeepLink();}}

async function handleDeepLink(){const sp=new URLSearchParams(window.location.search);const letterId=sp.get('letter');if(!letterId)return;window.history.replaceState({},'',window.location.pathname);if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(letterId)){console.warn('Invalid letter ID format');return;}try{await openSavedLetter(letterId);}catch(e){console.warn('Deep link failed:',e.message);}}

// --- Firm Settings (Supabase-persisted) ---
async function saveFirmSetting(key, value) {
  // Save to localStorage as cache
  localStorage.setItem('firm_' + key, value);
  // Persist to Supabase
  if (!currentUser) return;
  try {
    const { error } = await db.from('firm_settings').upsert(
      { key, value, updated_by: currentUser.id, updated_at: new Date().toISOString() },
      { onConflict: 'key' }
    );
    if (error) throw error;
  } catch (e) {
    console.warn('Failed to save setting to DB:', e.message);
  }
}

async function deleteFirmSetting(key) {
  localStorage.removeItem('firm_' + key);
  if (!currentUser) return;
  try {
    await db.from('firm_settings').delete().eq('key', key);
  } catch (e) {
    console.warn('Failed to delete setting from DB:', e.message);
  }
}

async function loadFirmSettings() {
  if (!currentUser) return;
  // Migrate legacy localStorage keys to new firm_ prefix
  const oldLogo = localStorage.getItem('firmLogoDataUrl');
  if (oldLogo && !localStorage.getItem('firm_logoDataUrl')) {
    localStorage.setItem('firm_logoDataUrl', oldLogo);
    localStorage.removeItem('firmLogoDataUrl');
    saveFirmSetting('logoDataUrl', oldLogo);
  }
  try {
    const { data, error } = await db.from('firm_settings').select('key, value');
    if (error) throw error;
    if (data) {
      data.forEach(row => {
        localStorage.setItem('firm_' + row.key, row.value);
      });
    }
  } catch (e) {
    // Table may not exist yet — fall back to localStorage silently
    console.warn('Could not load firm settings:', e.message);
  }
  // Restore UI after loading
  restoreLogoPreview();
  restoreSlackUI();
  restoreEmailUI();
  restoreBoldsignUI();
}

// --- Firm Logo for Engagement Letter Header ---
function handleLogoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!file.type.match(/^image\/(png|jpeg)$/)) {
    showStatus('Please upload a PNG or JPG image.', 'error');
    return;
  }
  if (file.size > 2 * 1024 * 1024) {
    showStatus('Logo must be under 2 MB.', 'error');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    saveFirmSetting('logoDataUrl', dataUrl);
    updateLogoPreview(dataUrl);
    showStatus('\u2713 Logo saved! It will appear in all future engagement letters.', 'success');
  };
  reader.onerror = function() {
    showStatus('Failed to read image file.', 'error');
  };
  reader.readAsDataURL(file);
}

function restoreLogoPreview() {
  const saved = localStorage.getItem('firm_logoDataUrl');
  if (saved) updateLogoPreview(saved);
  else hideLogoPreview();
}

function updateLogoPreview(dataUrl) {
  const area = document.getElementById('logoPreviewArea');
  const img = document.getElementById('logoPreviewImg');
  if (area && img) {
    img.src = dataUrl;
    area.style.display = 'block';
  }
}

function hideLogoPreview() {
  const area = document.getElementById('logoPreviewArea');
  if (area) area.style.display = 'none';
}

function removeLogo() {
  deleteFirmSetting('logoDataUrl');
  hideLogoPreview();
  document.getElementById('logoFileInput').value = '';
  showStatus('Logo removed.', 'success');
}

function getFirmLogoData() {
  const dataUrl = localStorage.getItem('firm_logoDataUrl');
  if (!dataUrl) return null;
  try {
    const base64 = dataUrl.split(',')[1];
    if (!base64) return null;
    atob(base64);
    return { base64 };
  } catch (e) {
    localStorage.removeItem('firm_logoDataUrl');
    return null;
  }
}
// --- End Logo ---

// --- Slack Integration ---
function toggleSlack() {
  const toggle = document.getElementById('slackToggle');
  const enabled = toggle.checked;
  if (enabled) {
    saveFirmSetting('slackEnabled', 'true');
    // Clean up legacy keys
    localStorage.removeItem('slackWebhookUrl');
    localStorage.removeItem('slackEnabled');
    updateSlackUI();
    showStatus('\u2713 Slack notifications enabled! Webhook is configured server-side.', 'success');
  } else {
    deleteFirmSetting('slackEnabled');
    localStorage.removeItem('slackWebhookUrl');
    localStorage.removeItem('slackEnabled');
    updateSlackUI();
    showStatus('Slack notifications disabled.', 'success');
  }
}

function isSlackEnabled() {
  return localStorage.getItem('firm_slackEnabled') === 'true'
    || localStorage.getItem('slackEnabled') === 'true'
    || !!localStorage.getItem('slackWebhookUrl');
}

function updateSlackUI() {
  const enabled = isSlackEnabled();
  // Update toggle in settings tab
  const toggle = document.getElementById('slackToggle');
  if (toggle) toggle.checked = enabled;
  const statusText = document.getElementById('slackStatusText');
  if (statusText) statusText.textContent = enabled ? 'Enabled' : 'Disabled';
  // Show/hide all Send to Slack buttons
  document.getElementById('slackSendBtn').style.display = enabled ? '' : 'none';
  document.querySelectorAll('.slack-send-btn').forEach(b => b.style.display = enabled ? '' : 'none');
}

function restoreSlackUI() {
  // Migrate from legacy localStorage keys
  if (localStorage.getItem('slackWebhookUrl') || localStorage.getItem('zapierWebhookUrl')) {
    localStorage.setItem('firm_slackEnabled', 'true');
    localStorage.removeItem('slackWebhookUrl');
    localStorage.removeItem('zapierWebhookUrl');
  }
  // Also migrate old slackEnabled key
  if (localStorage.getItem('slackEnabled') === 'true' && !localStorage.getItem('firm_slackEnabled')) {
    localStorage.setItem('firm_slackEnabled', 'true');
  }
  updateSlackUI();
}

// --- Client Email Delivery ---
function toggleEmail() {
  const toggle = document.getElementById('emailToggle');
  if (toggle.checked) {
    saveFirmSetting('emailEnabled', 'true');
    updateEmailUI();
    showStatus('\u2713 Client email delivery enabled! Configure the Resend API key in your Supabase Edge Function secrets.', 'success');
  } else {
    deleteFirmSetting('emailEnabled');
    updateEmailUI();
    showStatus('Client email delivery disabled.', 'success');
  }
}

function saveEmailReplyTo() {
  const val = document.getElementById('emailReplyTo').value.trim();
  if (val) {
    saveFirmSetting('emailReplyTo', val);
    showStatus('\u2713 Reply-to address saved.', 'success');
  } else {
    deleteFirmSetting('emailReplyTo');
  }
}

function isEmailEnabled() {
  return localStorage.getItem('firm_emailEnabled') === 'true';
}

function getEmailReplyTo() {
  return localStorage.getItem('firm_emailReplyTo') || '';
}

function updateEmailUI() {
  const enabled = isEmailEnabled();
  const toggle = document.getElementById('emailToggle');
  if (toggle) toggle.checked = enabled;
  const statusText = document.getElementById('emailStatusText');
  if (statusText) statusText.textContent = enabled ? 'Enabled' : 'Disabled';
  const replyToInput = document.getElementById('emailReplyTo');
  if (replyToInput) replyToInput.value = getEmailReplyTo();
  // Show/hide Send to Client buttons
  const headerBtn = document.getElementById('emailSendBtn');
  if (headerBtn) headerBtn.style.display = enabled ? '' : 'none';
  document.querySelectorAll('.email-send-btn').forEach(b => b.style.display = enabled ? '' : 'none');
}

function restoreEmailUI() {
  updateEmailUI();
}

// --- BoldSign E-Signature ---
function toggleBoldsign() {
  const toggle = document.getElementById('boldsignToggle');
  if (toggle.checked) {
    saveFirmSetting('boldsignEnabled', 'true');
    updateBoldsignUI();
    showStatus('\u2713 BoldSign e-signature enabled! Configure BOLDSIGN_API_KEY in your Supabase Edge Function secrets.', 'success');
  } else {
    deleteFirmSetting('boldsignEnabled');
    updateBoldsignUI();
    showStatus('BoldSign e-signature disabled.', 'success');
  }
}

function isBoldsignEnabled() {
  return localStorage.getItem('firm_boldsignEnabled') === 'true';
}

function updateBoldsignUI() {
  const enabled = isBoldsignEnabled();
  const toggle = document.getElementById('boldsignToggle');
  if (toggle) toggle.checked = enabled;
  const statusText = document.getElementById('boldsignStatusText');
  if (statusText) statusText.textContent = enabled ? 'Enabled' : 'Disabled';
  const headerBtn = document.getElementById('boldsignSendBtn');
  if (headerBtn) headerBtn.style.display = enabled ? '' : 'none';
  document.querySelectorAll('.boldsign-send-btn').forEach(b => b.style.display = enabled ? '' : 'none');
}

function restoreBoldsignUI() {
  updateBoldsignUI();
}

function toggleEsignCompose() {
  const panel = document.getElementById('esignComposePanel');
  if (panel) {
    const isVisible = panel.classList.contains('visible');
    if (isVisible) {
      panel.classList.remove('visible');
    } else {
      // Hide email compose if open
      const emailPanel = document.getElementById('emailComposePanel');
      if (emailPanel) emailPanel.classList.remove('visible');
      panel.classList.add('visible');
      panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    return;
  }
}

function renderEsignComposePanel(meta) {
  const clientEmail = meta.email || '';
  const contact = meta.contact || meta.clientLabel || '';
  const clientName = meta.clientLabel || meta.name || '';
  const matterLabel = meta.matter || '';

  const message = `Please review and sign the attached engagement letter for the above-referenced matter. If you have any questions, please do not hesitate to contact us.`;

  let html = `<div class="email-compose-panel" id="esignComposePanel">`;
  html += `<div class="email-compose-header" style="border-left:3px solid #6C5CE7;"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg> Send for E-Signature</h3><button class="close-compose" onclick="toggleEsignCompose()" title="Close">&times;</button></div>`;
  html += `<div class="email-compose-body">`;
  html += `<div class="email-field-row"><div class="email-field"><label>Signer Email</label><input type="email" id="esignEmail" value="${esc(clientEmail)}" placeholder="client@example.com"></div>`;
  html += `<div class="email-field"><label>Signer Name</label><input type="text" id="esignName" value="${esc(contact || clientName)}" placeholder="Full name"></div></div>`;
  html += `<div class="email-field"><label>Message to Signer <span style="font-weight:400;color:var(--warm-gray)">(optional)</span></label><textarea id="esignMessage" rows="3">${esc(message)}</textarea></div>`;
  html += `</div>`;
  html += `<div class="email-compose-footer">`;
  html += `<span style="font-size:11px;color:var(--warm-gray);flex:1;">The engagement letter PDF will be sent via BoldSign. The client will receive a link to sign electronically.</span>`;
  html += `<button class="btn btn-sm boldsign-send-btn" style="background:#6C5CE7;color:var(--white);" onclick="sendForESignature()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg> Send for Signature</button>`;
  html += `</div></div>`;
  return html;
}

let _lastPdfSignaturePageNum = null;

async function sendForESignature() {
  if (!_letterReviewMeta || !_letterReviewSections) return;

  const signerEmail = document.getElementById('esignEmail').value.trim();
  const signerName = document.getElementById('esignName').value.trim();
  const message = document.getElementById('esignMessage').value.trim();

  if (!signerEmail) { showStatus('Please enter the signer\'s email address.', 'error'); return; }
  if (!signerName) { showStatus('Please enter the signer\'s name.', 'error'); return; }

  if (/[\r\n]/.test(signerEmail) || /[\r\n]/.test(signerName)) {
    showStatus('Invalid characters in email or name.', 'error'); return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(signerEmail)) { showStatus('Invalid signer email address.', 'error'); return; }

  // Disable all send buttons
  const sendBtns = document.querySelectorAll('.boldsign-send-btn');
  const savedLabels = [];
  sendBtns.forEach(b => { savedLabels.push(b.innerHTML); b.disabled = true; b.innerHTML = '<div class="loading-spinner"></div> Sending...'; });

  try {
    // Save letter first
    await saveLetterToDb();

    // Generate PDF blob
    const blob = await buildPdfBlob();
    if (!blob) throw new Error('Failed to generate PDF');

    const arrayBuf = await blob.arrayBuffer();
    const bytes = new Uint8Array(arrayBuf);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    const pdfBase64 = btoa(binary);

    const meta = _letterReviewMeta;
    const fileName = `Engagement_Letter_${meta.name.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
    const title = `Engagement Letter \u2014 ${meta.matter} \u2014 ${meta.name}`;

    // Get the latest letter ID for tracking
    let letterId = null;
    if (_letterClientId) {
      try {
        const { data: latest } = await db.from('engagement_letters')
          .select('id')
          .eq('client_id', _letterClientId)
          .order('created_at', { ascending: false })
          .limit(1);
        if (latest && latest.length > 0) letterId = latest[0].id;
      } catch (e) { /* table may not exist */ }
    }

    // Get auth session
    let session = (await db.auth.getSession()).data.session;
    if (!session) throw new Error('Not authenticated \u2014 please sign in again.');

    const nowSec = Math.floor(Date.now() / 1000);
    if (session.expires_at && (session.expires_at - nowSec) < 120) {
      const { data, error: refreshErr } = await db.auth.refreshSession();
      if (refreshErr || !data.session) throw new Error('Session expired \u2014 please sign in again.');
      session = data.session;
    }

    const payload = {
      pdfBase64,
      fileName,
      signerName,
      signerEmail,
      title,
      message: message || undefined,
      clientId: _letterClientId || undefined,
      letterId: letterId || undefined,
      signaturePageNumber: _lastPdfSignaturePageNum || 2,
    };

    const res = await fetch(`${SUPABASE_URL}/functions/v1/send-for-esignature`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify(payload)
    });


    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      if (res.status === 401) throw new Error('Authentication error \u2014 try signing out and back in.');
      throw new Error(err.detail || err.error || `E-signature send failed (${res.status})`);
    }

    const result = await res.json();

    // Update client status locally
    if (_letterClientId) {
      await updateClientStatus(_letterClientId, 'Letter Sent');
    }

    // Notify Slack if enabled (best-effort)
    if (isSlackEnabled()) {
      try {
        const sentBy = currentUser ? currentUser.email : 'unknown';
        await notifySlack({
          text: `Engagement letter sent for e-signature to ${signerEmail} for ${meta.name}`,
          blocks: [
            { type: 'header', text: { type: 'plain_text', text: 'Engagement Letter Sent for E-Signature', emoji: true } },
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
              { type: 'mrkdwn', text: `*Sent To:*\n${escSlack(signerEmail)}` }
            ]},
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` },
              { type: 'mrkdwn', text: `*Attorney:*\n${escSlack(meta.atty)}` }
            ]},
            { type: 'context', elements: [
              { type: 'mrkdwn', text: `Sent by ${escSlack(sentBy)} via BoldSign` }
            ]},
          ]
        });
      } catch (e) { /* best-effort */ }
    }

    // Close compose panel and show success
    const panel = document.getElementById('esignComposePanel');
    if (panel) panel.classList.remove('visible');

    showStatus(`\u2713 Engagement letter sent to ${signerEmail} for electronic signature via BoldSign.`, 'success');
  } catch (err) {
    showStatus('E-signature error: ' + err.message, 'error');
  } finally {
    sendBtns.forEach((b, i) => { b.disabled = false; b.innerHTML = savedLabels[i]; });
  }
}
// --- End BoldSign E-Signature ---

function toggleEmailCompose() {
  const panel = document.getElementById('emailComposePanel');
  if (panel) {
    const isVisible = panel.classList.contains('visible');
    if (isVisible) {
      panel.classList.remove('visible');
    } else {
      // Hide e-sign compose if open
      const esignPanel = document.getElementById('esignComposePanel');
      if (esignPanel) esignPanel.classList.remove('visible');
      panel.classList.add('visible');
      panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    return;
  }
  // Panel doesn't exist yet — it gets rendered in showLetterModal via renderEmailComposePanel
}

function renderEmailComposePanel(meta) {
  const clientEmail = meta.email || '';
  const senderAtty = meta.sigFull || 'Matt A. Margolis';
  const contact = meta.contact || meta.clientLabel || '';
  const matterLabel = meta.matter || '';
  const clientName = meta.clientLabel || meta.name || '';

  const subject = `Engagement Letter \u2014 ${matterLabel} \u2014 Margolis PLLC`;

  const bodyText = `Dear ${contact},\n\nThank you for choosing Margolis PLLC. Please find attached your engagement letter for the above-referenced matter.\n\nPlease review the enclosed engagement letter carefully. If the arrangement described is acceptable, kindly sign a copy and return it to us via email.\n\nIf you have any questions or would like to discuss any of the terms, please do not hesitate to contact me.\n\nBest regards,\n${senderAtty}, Esq.\nMargolis PLLC`;

  let html = `<div class="email-compose-panel" id="emailComposePanel">`;
  html += `<div class="email-compose-header"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Send to Client</h3><button class="close-compose" onclick="toggleEmailCompose()" title="Close">&times;</button></div>`;
  html += `<div class="email-compose-body">`;
  html += `<div class="email-field-row"><div class="email-field"><label>To</label><input type="email" id="emailTo" value="${esc(clientEmail)}" placeholder="client@example.com"></div>`;
  html += `<div class="email-field"><label>CC <span style="font-weight:400;color:var(--warm-gray)">(optional)</span></label><input type="email" id="emailCc" placeholder="colleague@margolispllc.com"></div></div>`;
  html += `<div class="email-field"><label>Subject</label><input type="text" id="emailSubject" value="${esc(subject)}"></div>`;
  html += `<div class="email-field"><label>Message</label><textarea id="emailBody">${esc(bodyText)}</textarea></div>`;
  html += `</div>`;
  html += `<div class="email-compose-footer">`;
  html += `<span style="font-size:11px;color:var(--warm-gray);flex:1;">The engagement letter .docx will be attached automatically.</span>`;
  html += `<button class="btn btn-send-email btn-sm" onclick="sendToClient()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Send Email</button>`;
  html += `</div></div>`;
  return html;
}

async function sendToClient() {
  if (!_letterReviewMeta || !_letterReviewSections) return;

  const to = document.getElementById('emailTo').value.trim();
  const cc = document.getElementById('emailCc').value.trim();
  const subject = document.getElementById('emailSubject').value.trim();
  const bodyText = document.getElementById('emailBody').value.trim();

  if (!to) { showStatus('Please enter a recipient email address.', 'error'); return; }
  if (!subject) { showStatus('Please enter a subject line.', 'error'); return; }
  if (!bodyText) { showStatus('Please enter a message body.', 'error'); return; }

  // CRLF injection prevention — reject newlines in header-sensitive fields
  if (/[\r\n]/.test(to) || /[\r\n]/.test(subject)) {
    showStatus('Invalid characters in email or subject.', 'error'); return;
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(to)) { showStatus('Invalid recipient email address.', 'error'); return; }
  if (cc && (!emailRegex.test(cc) || /[\r\n]/.test(cc))) { showStatus('Invalid CC email address.', 'error'); return; }

  // Disable all send buttons
  const sendBtns = document.querySelectorAll('.btn-send-email');
  const savedLabels = [];
  sendBtns.forEach(b => { savedLabels.push(b.innerHTML); b.disabled = true; b.innerHTML = '<div class="loading-spinner"></div> Sending...'; });

  try {
    // Save letter first
    await saveLetterToDb();

    // Generate PDF blob for client email attachment
    const blob = await buildPdfBlob();
    if (!blob) throw new Error('Failed to generate PDF');

    const arrayBuf = await blob.arrayBuffer();
    const bytes = new Uint8Array(arrayBuf);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
    const attachmentBase64 = btoa(binary);

    const meta = _letterReviewMeta;
    const fileName = `Engagement_Letter_${meta.name.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;

    // Build HTML email body from plain text
    const htmlBody = bodyText.split('\n').map(line => line ? `<p style="margin:0 0 10px;font-family:Georgia,serif;font-size:14px;color:#333;">${esc(line)}</p>` : `<br>`).join('\n');

    // Determine reply-to: firm setting, or sending attorney's email
    const replyTo = getEmailReplyTo() || (currentUser ? currentUser.email : '');

    // Get auth session
    let session = (await db.auth.getSession()).data.session;
    if (!session) throw new Error('Not authenticated — please sign in again.');

    const nowSec = Math.floor(Date.now() / 1000);
    if (session.expires_at && (session.expires_at - nowSec) < 120) {
      const { data, error: refreshErr } = await db.auth.refreshSession();
      if (refreshErr || !data.session) throw new Error('Session expired — please sign in again.');
      session = data.session;
    }

    const payload = {
      to,
      subject,
      html: htmlBody,
      replyTo,
      attachmentBase64,
      attachmentFilename: fileName,
    };

    const res = await fetch(`${SUPABASE_URL}/functions/v1/send-letter-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${session.access_token}`
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      if (res.status === 401) throw new Error('Authentication error — try signing out and back in.');
      throw new Error(err.detail || err.error || `Email send failed (${res.status})`);
    }

    // Auto-update client status to "Letter Sent"
    if (_letterClientId) {
      await updateClientStatus(_letterClientId, 'Letter Sent');
    }

    // Notify Slack if enabled (best-effort)
    if (isSlackEnabled()) {
      try {
        const sentBy = currentUser ? currentUser.email : 'unknown';
        await notifySlack({
          text: `Engagement letter emailed to ${to} for ${meta.name}`,
          blocks: [
            { type: 'header', text: { type: 'plain_text', text: 'Engagement Letter Sent to Client', emoji: true } },
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
              { type: 'mrkdwn', text: `*Sent To:*\n${escSlack(to)}` }
            ]},
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` },
              { type: 'mrkdwn', text: `*Attorney:*\n${escSlack(meta.atty)}` }
            ]},
            { type: 'context', elements: [
              { type: 'mrkdwn', text: `Sent by ${escSlack(sentBy)}` }
            ]},
          ]
        });
      } catch (e) { /* best-effort */ }
    }

    // Close compose panel and show success
    const panel = document.getElementById('emailComposePanel');
    if (panel) panel.classList.remove('visible');

    showStatus(`\u2713 Engagement letter emailed to ${to}. Status updated to "Letter Sent".`, 'success');
  } catch (err) {
    showStatus('Email error: ' + err.message, 'error');
  } finally {
    sendBtns.forEach((b, i) => { b.disabled = false; b.innerHTML = savedLabels[i]; });
  }
}
// --- End Client Email ---

async function buildDocxBlob() {
  if (!_letterReviewMeta || !_letterReviewSections) return null;

  const meta = _letterReviewMeta;
  const revDate = document.getElementById('rev_date').value;
  const revRecipient = document.getElementById('rev_recipient').value;
  const revAttention = document.getElementById('rev_attention') ? document.getElementById('rev_attention').value : '';
  const revEmail = document.getElementById('rev_email').value;
  const revRe = document.getElementById('rev_re').value;
  const revGreeting = document.getElementById('rev_greeting').value;

  const editedSections = {};
  _letterReviewSections.forEach(s => {
    editedSections[s.id] = sanitizeHtml(document.getElementById('rev_'+s.id).innerHTML);
  });

  const { Document, Packer, Paragraph, TextRun, ImageRun, AlignmentType, Header, BorderStyle, UnderlineType, Table, TableRow, TableCell, WidthType, VerticalAlign } = window.docx;

  const f = 'Times New Roman', sz = 22;
  const tr = (text, opts={}) => new TextRun({ font:f, size:sz, ...opts, text });
  const bold = text => tr(text, { bold:true });
  const ul = text => tr(text, { underline:{type:UnderlineType.SINGLE} });
  const bu = text => tr(text, { bold:true, underline:{type:UnderlineType.SINGLE} });
  const bi = text => tr(text, { bold:true, italics:true, underline:{type:UnderlineType.SINGLE} });
  const sp = { after: 200, line: 240 };
  const spTight = { after: 0, line: 240 };

  function pp(runs, opts={}) {
    const children = Array.isArray(runs) ? runs : [tr(runs)];
    return new Paragraph({ spacing:opts.spacing||sp, alignment:opts.align||AlignmentType.JUSTIFIED, children });
  }
  function blank() { return new Paragraph({ spacing:{ after: 0, line: 240 }, children:[] }); }
  // Parse HTML from rich editor into arrays of TextRuns (one array per paragraph)
  function parseHtmlToRunArrays(html) {
    const container = document.createElement('div');
    container.innerHTML = html;
    const paragraphs = [];
    let currentRuns = [];
    function flush() {
      if (currentRuns.length > 0) { paragraphs.push(currentRuns); currentRuns = []; }
    }
    function walk(node, fmt) {
      if (node.nodeType === Node.TEXT_NODE) {
        const t = node.textContent;
        if (t) {
          const o = {};
          if (fmt.b) o.bold = true;
          if (fmt.i) o.italics = true;
          if (fmt.u) o.underline = {type:UnderlineType.SINGLE};
          currentRuns.push(tr(t, o));
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        const nf = {...fmt};
        if (tag==='b'||tag==='strong') nf.b = true;
        if (tag==='i'||tag==='em') nf.i = true;
        if (tag==='u') nf.u = true;
        if (tag==='div'||tag==='p') { flush(); for (const c of node.childNodes) walk(c, nf); flush(); }
        else if (tag==='br') { flush(); }
        else { for (const c of node.childNodes) walk(c, nf); }
      }
    }
    for (const c of container.childNodes) walk(c, {b:false,i:false,u:false});
    flush();
    return paragraphs;
  }
  function htmlToParas(html, opts={}) {
    return parseHtmlToRunArrays(html).filter(r=>r.length>0).map(runs => pp(runs, opts));
  }
  function sectParasHtml(num, titleLabel, html) {
    const ra = parseHtmlToRunArrays(html);
    const result = [];
    if (ra.length > 0 && ra[0].length > 0) {
      result.push(pp([tr(`${num}. `), ul(titleLabel+':'), tr(' '), ...ra[0]]));
      for (let i=1; i<ra.length; i++) { if (ra[i].length>0) result.push(pp(ra[i])); }
    }
    return result;
  }

  const body = [];
  body.push(blank());
  body.push(pp(revDate, {align:AlignmentType.CENTER}));
  body.push(blank());
  body.push(pp([bi('VIA ELECTRONIC MAIL ONLY')], {align:AlignmentType.LEFT}));
  body.push(pp(revRecipient, {align:AlignmentType.LEFT, spacing:spTight}));
  if (revAttention) body.push(pp(`ATTENTION: ${revAttention}`, {align:AlignmentType.LEFT, spacing:spTight}));
  if (revEmail) body.push(pp(revEmail, {align:AlignmentType.LEFT, spacing:spTight}));
  body.push(blank());
  body.push(pp([bold(`Re: ${revRe}`)], {align:AlignmentType.LEFT}));
  body.push(blank());
  body.push(blank());
  body.push(pp(revGreeting, {align:AlignmentType.LEFT}));
  htmlToParas(editedSections.intro).forEach(p => body.push(p));

  const sectionDefs = [
    {num:1, key:'s1', title:'Attorney in Charge'},{num:2, key:'s2', title:'Client'},
    {num:3, key:'s3', title:'Scope'},{num:4, key:'s4', title:'What we need from you'},
    {num:5, key:'s5', title:'Advice about Possible Outcomes'},{num:6, key:'s6', title:'Legal Services Fees'},
    {num:7, key:'s7', title:'Costs'},{num:8, key:'s8', title:'Payment'},
    {num:9, key:'s9', title:'Conflicts of Interest and Waiver'},
    {num:10, key:'s10', title:'Specialist/Local Network and Fee Sharing'},
    {num:11, key:'s11', title:'Use of Artificial Intelligence Tools'},
    {num:12, key:'s12', title:'Termination of Engagement'},
    {num:13, key:'s13', title:'Conclusion of Representation; Retention and Disposition of Documents'},
    {num:14, key:'s14', title:'Post-Engagement Matters'},
    {num:15, key:'s15', title:'Choice of Law & Venue'},
  ];
  sectionDefs.forEach(sd => {
    sectParasHtml(sd.num, sd.title, editedSections[sd.key]).forEach(p => body.push(p));
  });

  htmlToParas(editedSections.closing).forEach(p => body.push(p));
  body.push(blank());
  body.push(pp([tr('[Signatures on following page]', {italics:true})], {align:AlignmentType.CENTER}));

  // --- Signature page (forced page break) ---
  body.push(new Paragraph({ pageBreakBefore:true, spacing:sp, alignment:AlignmentType.LEFT, children:[tr('Sincerely,')] }));
  body.push(blank()); body.push(blank()); body.push(blank());
  body.push(pp([bold('MARGOLIS PLLC')], {align:AlignmentType.LEFT}));
  body.push(blank());
  body.push(pp([bi(`/s/ ${meta.sigFull}`)], {align:AlignmentType.LEFT}));
  body.push(blank());
  body.push(pp(`By: ${meta.sigShort}, Esq.`, {align:AlignmentType.LEFT, spacing:spTight}));
  body.push(pp('For the Firm', {align:AlignmentType.LEFT}));
  body.push(blank()); body.push(blank());
  body.push(pp([bold('ACKNOWLEDGED AND AGREED:')], {align:AlignmentType.LEFT}));
  body.push(blank());
  body.push(pp(revRecipient, {align:AlignmentType.LEFT}));
  body.push(blank());
  body.push(pp('By: _____________________________', {align:AlignmentType.LEFT, spacing:spTight}));
  body.push(pp('Name: __________________________', {align:AlignmentType.LEFT, spacing:spTight}));
  body.push(pp('Date: ___________________________', {align:AlignmentType.LEFT, spacing:spTight}));

  body.push(new Paragraph({ pageBreakBefore:true, spacing:sp, alignment:AlignmentType.CENTER, children:[bu('EXHIBIT A')] }));
  body.push(blank());
  body.push(new Paragraph({ spacing:sp, alignment:AlignmentType.CENTER, children:[bu('SCOPE OF SERVICES')] }));
  body.push(blank());
  htmlToParas(editedSections.exhibit).forEach(p => body.push(p));

  const firmLogo = getFirmLogoData();

  const noBorder = { style: BorderStyle.NONE, size: 0, color: 'FFFFFF' };
  const noBorders = { top: noBorder, bottom: noBorder, left: noBorder, right: noBorder };
  const headerSage = '8B9D93';
  const hdrFont = 'Times New Roman';
  const hdrSize = 16;
  const hdrSpacing = { after: 0, line: 240 };

  let headerChildren;
  if (firmLogo) {
    headerChildren = [new Table({
      rows: [new TableRow({
        children: [
          new TableCell({
            width: { size: 15, type: WidthType.PERCENTAGE },
            borders: noBorders,
            verticalAlign: VerticalAlign.CENTER,
            children: [new Paragraph({ alignment: AlignmentType.LEFT, children: [
              new ImageRun({ data: firmLogo.base64, transformation: { width: 85, height: 85 } })
            ]})]
          }),
          new TableCell({
            width: { size: 85, type: WidthType.PERCENTAGE },
            borders: noBorders,
            verticalAlign: VerticalAlign.CENTER,
            children: [
              new Paragraph({ alignment: AlignmentType.RIGHT, spacing: hdrSpacing, children: [
                new TextRun({ font: hdrFont, size: hdrSize, color: headerSage, text: 'MATT A. MARGOLIS, ESQ. / PARTNER /' })
              ]}),
              new Paragraph({ alignment: AlignmentType.RIGHT, spacing: hdrSpacing, children: [
                new TextRun({ font: hdrFont, size: hdrSize, color: headerSage, text: 'MATTHEW@MARGOLISPLLC.COM' })
              ]}),
              new Paragraph({ alignment: AlignmentType.RIGHT, spacing: hdrSpacing, children: [] }),
              new Paragraph({ alignment: AlignmentType.RIGHT, spacing: hdrSpacing, children: [
                new TextRun({ font: hdrFont, size: hdrSize, color: headerSage, text: 'KARINA S. MARGOLIS, ESQ. / PARTNER /' })
              ]}),
              new Paragraph({ alignment: AlignmentType.RIGHT, spacing: hdrSpacing, children: [
                new TextRun({ font: hdrFont, size: hdrSize, color: headerSage, text: 'KARINA@MARGOLISPLLC.COM' })
              ]})
            ]
          })
        ]
      })],
      width: { size: 100, type: WidthType.PERCENTAGE }
    })];
  } else {
    headerChildren = [];
  }

  const doc = new Document({
    styles:{default:{document:{run:{font:'Times New Roman',size:22}}}},
    sections:[{ properties:{ page:{size:{width:12240,height:15840},margin:{top:firmLogo?1800:1440,right:1440,bottom:1440,left:1440}}, titlePage:true }, headers:{ first:new Header({children:headerChildren}), default:new Header({children:[]}) }, children:body }]
  });

  return await Packer.toBlob(doc);
}

// --- PDF generation for client emails ---
async function buildPdfBlob() {
  if (!_letterReviewMeta || !_letterReviewSections) return null;

  const meta = _letterReviewMeta;
  const revDate = document.getElementById('rev_date').value;
  const revRecipient = document.getElementById('rev_recipient').value;
  const revAttention = document.getElementById('rev_attention') ? document.getElementById('rev_attention').value : '';
  const revEmail = document.getElementById('rev_email').value;
  const revRe = document.getElementById('rev_re').value;
  const revGreeting = document.getElementById('rev_greeting').value;

  const editedSections = {};
  _letterReviewSections.forEach(s => {
    editedSections[s.id] = sanitizeHtml(document.getElementById('rev_'+s.id).innerHTML);
  });

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'pt', format: 'letter' });

  // Page dimensions (letter = 612 x 792 pt)
  const PW = 612, PH = 792;
  const ML = 72, MR = 72, MB = 72;
  let MT = 72;
  const CW = PW - ML - MR; // content width = 468pt
  let y = MT;

  // --- Helpers ---
  function setF(style, size) { pdf.setFont('times', style || 'normal'); pdf.setFontSize(size || 11); }
  function checkPage(need) { if (y + (need||14) > PH - MB) { pdf.addPage(); y = MT; } }
  function blankLine(h) { y += (h || 14); }

  // Strip HTML to plain text
  function strip(html) { const d = document.createElement('div'); d.innerHTML = html; return (d.textContent || '').trim(); }

  // Parse HTML into paragraphs of text runs: [[{text,bold,italic,underline},...],...]
  function parseHtml(html) {
    const div = document.createElement('div'); div.innerHTML = html;
    const paras = []; let cur = [];
    function flush() { if (cur.length > 0) { paras.push(cur); cur = []; } }
    function walk(node, fmt) {
      if (node.nodeType === Node.TEXT_NODE) {
        const t = node.textContent;
        if (t) cur.push({ text: t, bold: fmt.b, italic: fmt.i, underline: fmt.u });
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const tag = node.tagName.toLowerCase();
        const nf = {...fmt};
        if (tag==='b'||tag==='strong') nf.b = true;
        if (tag==='i'||tag==='em') nf.i = true;
        if (tag==='u') nf.u = true;
        if (tag==='div'||tag==='p') { flush(); for (const c of node.childNodes) walk(c, nf); flush(); }
        else if (tag==='br') { flush(); }
        else { for (const c of node.childNodes) walk(c, nf); }
      }
    }
    for (const c of div.childNodes) walk(c, {b:false,i:false,u:false});
    flush();
    return paras;
  }

  // Get jsPDF font style string
  function fontStyle(run) {
    if (run.bold && run.italic) return 'bolditalic';
    if (run.bold) return 'bolditalic'.substring(0,4);
    if (run.italic) return 'italic';
    return 'normal';
  }

  // Render a single paragraph of formatted text runs with word wrapping
  function renderPara(runs, opts) {
    const fontSize = (opts && opts.size) || 11;
    const align = (opts && opts.align) || 'justify';
    const lh = fontSize * 1.4;
    const afterSpace = (opts && opts.after !== undefined) ? opts.after : 6;

    // Flatten runs into word tokens with formatting (separate actual words from spaces)
    const words = [];
    for (const run of runs) {
      const parts = run.text.split(/( +)/);
      for (const part of parts) {
        if (part.length > 0) {
          words.push({ text: part, bold: run.bold, italic: run.italic, underline: run.underline });
        }
      }
    }

    if (words.length === 0) return;
    checkPage(lh);

    let lineWords = [];
    let lineWidth = 0;

    function flushLine(isLast) {
      if (lineWords.length === 0) return;

      // Separate content words from space tokens
      const contentWords = lineWords.filter(w => w.text.trim().length > 0);
      const totalTextWidth = contentWords.reduce((sum, w) => {
        setF(fontStyle(w), fontSize);
        return sum + pdf.getTextWidth(w.text);
      }, 0);

      let x = ML;
      if (align === 'center') {
        x = ML + (CW - lineWidth) / 2;
        for (const w of lineWords) {
          setF(fontStyle(w), fontSize);
          pdf.text(w.text, x, y);
          if (w.underline) { const tw = pdf.getTextWidth(w.text); pdf.setLineWidth(0.5); pdf.line(x, y + 1.5, x + tw, y + 1.5); }
          x += pdf.getTextWidth(w.text);
        }
      } else if (align === 'right') {
        x = ML + CW - lineWidth;
        for (const w of lineWords) {
          setF(fontStyle(w), fontSize);
          pdf.text(w.text, x, y);
          if (w.underline) { const tw = pdf.getTextWidth(w.text); pdf.setLineWidth(0.5); pdf.line(x, y + 1.5, x + tw, y + 1.5); }
          x += pdf.getTextWidth(w.text);
        }
      } else if (align === 'justify' && !isLast && contentWords.length > 1) {
        // Distribute extra space evenly between words
        const gaps = contentWords.length - 1;
        const extraSpace = (CW - totalTextWidth) / gaps;
        for (let i = 0; i < contentWords.length; i++) {
          const w = contentWords[i];
          setF(fontStyle(w), fontSize);
          pdf.text(w.text, x, y);
          if (w.underline) { const tw = pdf.getTextWidth(w.text); pdf.setLineWidth(0.5); pdf.line(x, y + 1.5, x + tw, y + 1.5); }
          x += pdf.getTextWidth(w.text);
          if (i < contentWords.length - 1) x += extraSpace;
        }
      } else {
        // Left-align (or last line of justified paragraph)
        for (const w of lineWords) {
          setF(fontStyle(w), fontSize);
          pdf.text(w.text, x, y);
          if (w.underline) { const tw = pdf.getTextWidth(w.text); pdf.setLineWidth(0.5); pdf.line(x, y + 1.5, x + tw, y + 1.5); }
          x += pdf.getTextWidth(w.text);
        }
      }

      y += lh;
      checkPage(lh);
      lineWords = [];
      lineWidth = 0;
    }

    for (const w of words) {
      setF(fontStyle(w), fontSize);
      const ww = pdf.getTextWidth(w.text);
      if (lineWidth + ww > CW && lineWidth > 0 && w.text.trim()) {
        flushLine(false);
      }
      lineWords.push(w);
      lineWidth += ww;
    }
    flushLine(true);
    y += afterSpace;
  }

  // Render plain text line
  function addLine(text, opts) {
    const fontSize = (opts && opts.size) || 11;
    const style = (opts && opts.style) || 'normal';
    const align = (opts && opts.align) || 'left';
    const after = (opts && opts.after !== undefined) ? opts.after : 6;
    const lh = fontSize * 1.4;
    setF(style, fontSize);
    const lines = pdf.splitTextToSize(text, CW);
    for (const line of lines) {
      checkPage(lh);
      let x = ML;
      if (align === 'center') x = PW / 2;
      else if (align === 'right') x = PW - MR;
      pdf.text(line, x, y, { align });
      y += lh;
    }
    y += after;
  }

  // Render HTML section body
  function addHtmlParas(html, opts) {
    const paras = parseHtml(html);
    for (const runs of paras) {
      if (runs.length > 0) renderPara(runs, opts);
    }
  }

  // --- Header on first page ---
  const firmLogo = getFirmLogoData();
  if (firmLogo) {
    const logoDataUrl = localStorage.getItem('firm_logoDataUrl');
    if (logoDataUrl) {
      try { pdf.addImage(logoDataUrl, 'PNG', ML, 24, 55, 55); } catch(e) { /* skip logo if unsupported format */ }
    }
    // Attorney info - right aligned, sage color
    pdf.setTextColor(139, 157, 147);
    setF('normal', 8);
    const rx = PW - MR;
    pdf.text('MATT A. MARGOLIS, ESQ. / PARTNER /', rx, 32, { align: 'right' });
    pdf.text('MATTHEW@MARGOLISPLLC.COM', rx, 42, { align: 'right' });
    pdf.text('KARINA S. MARGOLIS, ESQ. / PARTNER /', rx, 58, { align: 'right' });
    pdf.text('KARINA@MARGOLISPLLC.COM', rx, 68, { align: 'right' });
    pdf.setTextColor(0, 0, 0);
    MT = 100;
    y = MT;
  }

  // --- Letter body ---
  blankLine(4);
  addLine(revDate, { align: 'center' });
  blankLine(8);

  // VIA ELECTRONIC MAIL ONLY
  renderPara([{ text: 'VIA ELECTRONIC MAIL ONLY', bold: true, italic: true, underline: true }], { after: 6 });
  addLine(revRecipient, { after: 0 });
  if (revAttention) addLine('ATTENTION: ' + revAttention, { after: 0 });
  if (revEmail) addLine(revEmail, { after: 0 });
  blankLine(8);

  // Re: line
  addLine('Re: ' + revRe, { style: 'bold' });
  blankLine(14);

  // Greeting
  addLine(revGreeting);
  addHtmlParas(editedSections.intro);

  // Numbered sections
  const sectionDefs = [
    {num:1, key:'s1', title:'Attorney in Charge'},{num:2, key:'s2', title:'Client'},
    {num:3, key:'s3', title:'Scope'},{num:4, key:'s4', title:'What we need from you'},
    {num:5, key:'s5', title:'Advice about Possible Outcomes'},{num:6, key:'s6', title:'Legal Services Fees'},
    {num:7, key:'s7', title:'Costs'},{num:8, key:'s8', title:'Payment'},
    {num:9, key:'s9', title:'Conflicts of Interest and Waiver'},
    {num:10, key:'s10', title:'Specialist/Local Network and Fee Sharing'},
    {num:11, key:'s11', title:'Use of Artificial Intelligence Tools'},
    {num:12, key:'s12', title:'Termination of Engagement'},
    {num:13, key:'s13', title:'Conclusion of Representation; Retention and Disposition of Documents'},
    {num:14, key:'s14', title:'Post-Engagement Matters'},
    {num:15, key:'s15', title:'Choice of Law & Venue'},
  ];

  for (const sd of sectionDefs) {
    const html = editedSections[sd.key];
    const paras = parseHtml(html);
    if (paras.length > 0 && paras[0].length > 0) {
      // First paragraph: prepend "N. Title: " then the content
      const prefix = [
        { text: sd.num + '. ', bold: false, italic: false, underline: false },
        { text: sd.title + ':', bold: false, italic: false, underline: true },
        { text: ' ', bold: false, italic: false, underline: false }
      ];
      renderPara([...prefix, ...paras[0]]);
      for (let i = 1; i < paras.length; i++) {
        if (paras[i].length > 0) renderPara(paras[i]);
      }
    }
  }

  // Closing
  addHtmlParas(editedSections.closing);
  blankLine(14);
  addLine('[Signatures on following page]', { align: 'center', style: 'italic' });

  // --- Signature page ---
  pdf.addPage();
  _lastPdfSignaturePageNum = pdf.getNumberOfPages();
  y = MT;

  addLine('Sincerely,', { after: 0 });
  blankLine(40);
  addLine('MARGOLIS PLLC', { style: 'bold', after: 8 });
  renderPara([{ text: '/s/ ' + meta.sigFull, bold: true, italic: true, underline: false }], { align: 'left', after: 8 });
  addLine('By: ' + meta.sigShort + ', Esq.', { after: 0 });
  addLine('For the Firm');
  blankLine(20);

  // Acknowledgment
  addLine('ACKNOWLEDGED AND AGREED:', { style: 'bold' });
  blankLine(4);
  addLine(revRecipient);
  blankLine(4);
  addLine('By: _____________________________', { after: 0 });
  addLine('Name: __________________________', { after: 0 });
  addLine('Date: ___________________________');

  // --- Exhibit A (new page) ---
  pdf.addPage();
  y = MT;
  renderPara([{ text: 'EXHIBIT A', bold: true, italic: false, underline: true }], { align: 'center', size: 11, after: 8 });
  renderPara([{ text: 'SCOPE OF SERVICES', bold: true, italic: false, underline: true }], { align: 'center', size: 11, after: 8 });
  blankLine(4);
  addHtmlParas(editedSections.exhibit);

  return pdf.output('blob');
}

async function sendToSlack() {
  if (!isSlackEnabled()) {
    showStatus('Slack not configured. Enable it in Settings.', 'error');
    return;
  }
  if (!_letterReviewMeta || !_letterReviewSections) return;

  const meta = _letterReviewMeta;
  const slackBtns = document.querySelectorAll('.btn-slack');
  const savedLabels = [];
  slackBtns.forEach(b => { savedLabels.push(b.innerHTML); b.disabled = true; b.innerHTML = '<div class="loading-spinner"></div> Sending...'; });

  try {
    const revDate = document.getElementById('rev_date').value;
    const sentBy = currentUser ? currentUser.email : 'unknown';

    // Save letter first so we can link to it
    let letterId = await saveLetterToDb();
    if (!letterId && _letterClientId) {
      try {
        const { data: latest } = await db.from('engagement_letters')
          .select('id')
          .eq('client_id', _letterClientId)
          .order('created_at', { ascending: false })
          .limit(1);
        if (latest && latest.length > 0) letterId = latest[0].id;
      } catch (e) { /* table may not exist */ }
    }
    const baseUrl = window.location.origin + window.location.pathname;
    const letterLink = letterId ? `${baseUrl}?letter=${letterId}` : baseUrl;

    const blocks = [
      { type: 'header', text: { type: 'plain_text', text: 'New Engagement Letter', emoji: true } },
      { type: 'section', fields: [
        { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
        { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` }
      ]},
      { type: 'section', fields: [
        { type: 'mrkdwn', text: `*Attorney:*\n${escSlack(meta.atty)}` },
        { type: 'mrkdwn', text: `*Date:*\n${escSlack(revDate)}` }
      ]},
      { type: 'actions', elements: [
        { type: 'button', text: { type: 'plain_text', text: 'View in Intakr', emoji: true }, url: letterLink, style: 'primary' }
      ]},
      { type: 'context', elements: [
        { type: 'mrkdwn', text: `Sent by ${escSlack(sentBy)} | <${letterLink}|Open in Intakr>` }
      ]},
    ];

    await notifySlack({
      text: `New Engagement Letter: ${escSlack(meta.name)} - ${escSlack(meta.matter)} — ${letterLink}`,
      blocks
    });

    showStatus(`\u2713 Sent to Slack for ${meta.name}.`, 'success');
  } catch (err) {
    showStatus('Slack error: ' + err.message, 'error');
  } finally {
    slackBtns.forEach((b, i) => { b.disabled = false; b.innerHTML = savedLabels[i]; });
  }
}
// --- End Slack ---

async function getClients(){try{const{data,error}=await db.from('clients').select('*').order('created_at',{ascending:false});if(error)throw error;return data||[];}catch(e){showStatus('Error: '+e.message,'error');return[];}}

async function addClient(d){try{const{data,error}=await db.from('clients').insert([{user_id:currentUser.id,client_type:d.clientType,entity_name:d.entityName,contact_name:d.contactName,contact_title:d.contactTitle,client_email:d.clientEmail,client_phone:d.clientPhone,client_address:d.clientAddress,matter_type:d.matterType,attorney:d.attorney,assigned_to:d.assignTo||null,matter_description:d.matterDescription,adverse_party:d.adverseParty,fee_type:d.feeType,hourly_rate:d.hourlyRate,paralegal_rate:d.paralegalRate,flat_fee_amount:d.flatFeeAmount,retainer_amount:d.retainerAmount,engagement_date:d.engagementDate,conflicts:d.conflicts,specialist_involved:d.specialistInvolved,specialist_name:d.specialistName,fee_sharing_details:d.feeSharingDetails,referral_source:d.referralSource,priority:d.priority,internal_notes:d.internalNotes,status:'Prospective'}]).select().single();if(error)throw error;updateTrackerCount();return data;}catch(e){showStatus('Error: '+e.message,'error');return null;}}

async function updateClientStatus(id,s){try{const u={status:s};const today=new Date().toISOString().slice(0,10);if(s==='Letter Sent')u.letter_sent=today;if(s==='Executed')u.letter_executed=today;const{error}=await db.from('clients').update(u).eq('id',id);if(error)throw error;renderDashboard();}catch(e){showStatus('Error: '+e.message,'error');}}

async function deleteClient(id){if(!confirm('Delete this client?'))return;try{const{error}=await db.from('clients').delete().eq('id',id);if(error)throw error;renderDashboard();showStatus('Removed.','success');}catch(e){showStatus('Error: '+e.message,'error');}}

async function clearAllData(){if(prompt('This will permanently delete ALL client records. Type DELETE to confirm')!=='DELETE')return;try{const{error}=await db.from('clients').delete().neq('id','00000000-0000-0000-0000-000000000000');if(error)throw error;renderDashboard();showStatus('Cleared.','success');}catch(e){showStatus('Error: '+e.message,'error');}}

// =============================================
// EDIT CLIENT FUNCTIONS
// =============================================

let _editClientId = null;

async function editClient(id) {
  const clients = await getClients();
  const c = clients.find(x => x.id === id);
  if (!c) { showStatus('Client not found.', 'error'); return; }
  _editClientId = id;

  const matterOptions = [
    'Corporate/Business Formation','Commercial Litigation','Real Estate','Employment',
    'Intellectual Property','Contract Drafting/Review','Regulatory/Compliance',
    'M&A/Transactions','Fractional General Counsel','Fractional Corporate Counsel','Other'
  ];
  const attorneyOptions = [
    'Matt A. Margolis, Esq.','Karina Margolis, Esq.','Jen Healy, Esq.','Hunter Sutherland, Esq.'
  ];

  const feeType = c.fee_type || 'Hourly';
  const showHourly = feeType === 'Hourly' || feeType === 'Hybrid';
  const showFlat = feeType === 'Flat Fee' || feeType === 'Hybrid';
  const showMonthly = feeType === 'Subscription';
  const showSpecialist = c.specialist_involved === 'Yes';

  let html = '';
  // Warning box
  html += `<div class="edit-warning-box">`;
  html += `<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;
  html += `<div class="edit-warning-text">`;
  html += `<strong>You are editing an existing matter</strong>`;
  html += `Changes to this record will update the client data in the tracker. If an engagement letter has already been generated, you may need to regenerate it to reflect any changes.`;
  html += `<div class="edit-ack-row"><input type="checkbox" id="editAckCheckbox"><label for="editAckCheckbox">I understand and want to proceed with editing this matter</label></div>`;
  html += `</div></div>`;

  // Form
  html += `<div class="edit-form-grid" id="editFormFields" style="opacity:0.5;pointer-events:none;">`;

  // Section: Client Info
  html += `<div class="edit-section-label">Client Information</div>`;
  html += `<div><label>Client Type</label><select id="edit_clientType"><option value="Individual" ${c.client_type==='Individual'?'selected':''}>Individual</option><option value="Business Entity" ${c.client_type==='Business Entity'?'selected':''}>Business Entity</option></select></div>`;
  html += `<div><label>Entity Name</label><input type="text" id="edit_entityName" value="${esc(c.entity_name||'')}"></div>`;
  html += `<div><label>Contact Full Name</label><input type="text" id="edit_contactName" value="${esc(c.contact_name||'')}"></div>`;
  html += `<div><label>Title / Role</label><input type="text" id="edit_contactTitle" value="${esc(c.contact_title||'')}"></div>`;
  html += `<div><label>Email</label><input type="email" id="edit_clientEmail" value="${esc(c.client_email||'')}"></div>`;
  html += `<div><label>Phone</label><input type="tel" id="edit_clientPhone" value="${esc(c.client_phone||'')}"></div>`;
  html += `<div class="full-width"><label>Mailing Address</label><input type="text" id="edit_clientAddress" value="${esc(c.client_address||'')}"></div>`;

  // Section: Matter Details
  html += `<div class="edit-section-label">Matter Details</div>`;
  html += `<div><label>Matter Type</label><select id="edit_matterType">${matterOptions.map(m => `<option value="${esc(m)}" ${(c.matter_type||'')===m?'selected':''}>${esc(m)}</option>`).join('')}</select></div>`;
  html += `<div><label>Attorney in Charge</label><select id="edit_attorney">${attorneyOptions.map(a => `<option value="${esc(a)}" ${(c.attorney||'')===a?'selected':''}>${esc(a)}</option>`).join('')}</select></div>`;
  html += `<div><label>Assign To</label><select id="edit_assignTo"><option value="">Not assigned</option>${attorneyOptions.map(a => `<option value="${esc(a)}" ${(c.assigned_to||'')===a?'selected':''}>${esc(a)}</option>`).join('')}</select></div>`;
  html += `<div class="full-width"><label>Matter Description</label><textarea id="edit_matterDescription">${esc(c.matter_description||'')}</textarea></div>`;
  html += `<div class="full-width"><label>Adverse / Opposing Party</label><input type="text" id="edit_adverseParty" value="${esc(c.adverse_party||'')}"></div>`;

  // Section: Fee Structure
  html += `<div class="edit-section-label">Fee Structure</div>`;
  html += `<div class="full-width"><label>Fee Type</label><div class="edit-fee-toggle" id="editFeeToggle">`;
  html += `<input type="radio" name="editFeeType" id="editFeeHourly" value="Hourly" ${feeType==='Hourly'?'checked':''}><label for="editFeeHourly" ${feeType==='Hourly'?'class="active"':''}>Hourly</label>`;
  html += `<input type="radio" name="editFeeType" id="editFeeFlat" value="Flat Fee" ${feeType==='Flat Fee'?'checked':''}><label for="editFeeFlat" ${feeType==='Flat Fee'?'class="active"':''}>Flat Fee</label>`;
  html += `<input type="radio" name="editFeeType" id="editFeeHybrid" value="Hybrid" ${feeType==='Hybrid'?'checked':''}><label for="editFeeHybrid" ${feeType==='Hybrid'?'class="active"':''}>Hybrid</label>`;
  html += `<input type="radio" name="editFeeType" id="editFeeSub" value="Subscription" ${feeType==='Subscription'?'checked':''}><label for="editFeeSub" ${feeType==='Subscription'?'class="active"':''}>Subscription</label>`;
  html += `</div></div>`;
  html += `<div id="editHourlyRateGroup" style="${showHourly?'':'display:none'}"><label>Attorney Hourly Rate</label><input type="text" id="edit_hourlyRate" value="${esc(c.hourly_rate||'')}"></div>`;
  html += `<div id="editParalegalRateGroup" style="${showHourly?'':'display:none'}"><label>Paralegal Hourly Rate</label><input type="text" id="edit_paralegalRate" value="${esc(c.paralegal_rate||'')}"></div>`;
  html += `<div id="editFlatFeeGroup" style="${showFlat?'':'display:none'}"><label>Flat Fee Amount</label><input type="text" id="edit_flatFeeAmount" value="${esc(c.flat_fee_amount||'')}"></div>`;
  html += `<div id="editMonthlyFeeGroup" style="${showMonthly?'':'display:none'}"><label>Monthly Subscription Fee</label><input type="text" id="edit_monthlyFee" value="${esc(c.retainer_amount||'')}"></div>`;
  html += `<div><label>Retainer Amount</label><input type="text" id="edit_retainerAmount" value="${esc(c.retainer_amount||'')}"></div>`;
  html += `<div><label>Engagement Date</label><input type="date" id="edit_engagementDate" value="${esc(c.engagement_date||'')}"></div>`;

  // Section: Conflicts & Referral
  html += `<div class="edit-section-label">Conflicts & Referral</div>`;
  html += `<div class="full-width"><label>Known Conflicts</label><textarea id="edit_conflicts">${esc(c.conflicts||'')}</textarea></div>`;
  html += `<div><label>Specialist Involved?</label><select id="edit_specialistInvolved"><option value="No" ${c.specialist_involved!=='Yes'?'selected':''}>No</option><option value="Yes" ${c.specialist_involved==='Yes'?'selected':''}>Yes</option></select></div>`;
  html += `<div id="editSpecialistName" style="${showSpecialist?'':'display:none'}"><label>Specialist Name</label><input type="text" id="edit_specialistName" value="${esc(c.specialist_name||'')}"></div>`;
  html += `<div class="full-width" id="editFeeSharingDetails" style="${showSpecialist?'':'display:none'}"><label>Fee-Sharing Arrangement</label><input type="text" id="edit_feeSharingDetails" value="${esc(c.fee_sharing_details||'')}"></div>`;

  // Section: Internal
  html += `<div class="edit-section-label">Internal Notes</div>`;
  html += `<div><label>Referral Source</label><input type="text" id="edit_referralSource" value="${esc(c.referral_source||'')}"></div>`;
  html += `<div><label>Priority</label><select id="edit_priority"><option value="Normal" ${c.priority!=='High'&&c.priority!=='Urgent'?'selected':''}>Normal</option><option value="High" ${c.priority==='High'?'selected':''}>High</option><option value="Urgent" ${c.priority==='Urgent'?'selected':''}>Urgent</option></select></div>`;
  html += `<div class="full-width"><label>Internal Notes</label><textarea id="edit_internalNotes">${esc(c.internal_notes||'')}</textarea></div>`;

  html += `</div>`; // close edit-form-grid

  // Actions
  html += `<div class="edit-actions">`;
  html += `<button class="btn btn-secondary btn-sm" onclick="closeEditClientModal()">Cancel</button>`;
  html += `<button class="btn btn-sm btn-save-edit" id="editSaveBtn" disabled onclick="saveClientEdits()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes</button>`;
  html += `</div>`;

  document.getElementById('editClientBody').innerHTML = html;

  // Acknowledgment checkbox enables/disables form
  document.getElementById('editAckCheckbox').addEventListener('change', function() {
    const fields = document.getElementById('editFormFields');
    const btn = document.getElementById('editSaveBtn');
    if (this.checked) {
      fields.style.opacity = '1';
      fields.style.pointerEvents = 'auto';
      btn.disabled = false;
    } else {
      fields.style.opacity = '0.5';
      fields.style.pointerEvents = 'none';
      btn.disabled = true;
    }
  });

  // Fee type toggle in edit modal
  document.querySelectorAll('#editFeeToggle input[type="radio"]').forEach(r => {
    r.addEventListener('change', () => {
      document.querySelectorAll('#editFeeToggle label').forEach(l => l.classList.remove('active'));
      r.nextElementSibling.classList.add('active');
      const v = r.value;
      document.getElementById('editHourlyRateGroup').style.display = (v==='Hourly'||v==='Hybrid') ? '' : 'none';
      document.getElementById('editParalegalRateGroup').style.display = (v==='Hourly'||v==='Hybrid') ? '' : 'none';
      document.getElementById('editFlatFeeGroup').style.display = (v==='Flat Fee'||v==='Hybrid') ? '' : 'none';
      document.getElementById('editMonthlyFeeGroup').style.display = v==='Subscription' ? '' : 'none';
    });
  });

  // Specialist toggle
  document.getElementById('edit_specialistInvolved').addEventListener('change', function() {
    const show = this.value === 'Yes';
    document.getElementById('editSpecialistName').style.display = show ? '' : 'none';
    document.getElementById('editFeeSharingDetails').style.display = show ? '' : 'none';
  });

  document.getElementById('editClientModal').classList.add('visible');
  document.body.style.overflow = 'hidden';
}

function closeEditClientModal() {
  document.getElementById('editClientModal').classList.remove('visible');
  document.body.style.overflow = '';
  _editClientId = null;
}

async function saveClientEdits() {
  if (!_editClientId) return;

  const contactName = document.getElementById('edit_contactName').value.trim();
  const clientEmail = document.getElementById('edit_clientEmail').value.trim();
  if (!contactName) { showStatus('Contact name is required.', 'error'); return; }
  if (!clientEmail) { showStatus('Email is required.', 'error'); return; }

  const btn = document.getElementById('editSaveBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loading-spinner"></div> Saving...';

  try {
    const updates = {
      client_type: document.getElementById('edit_clientType').value,
      entity_name: document.getElementById('edit_entityName').value,
      contact_name: contactName,
      contact_title: document.getElementById('edit_contactTitle').value,
      client_email: clientEmail,
      client_phone: document.getElementById('edit_clientPhone').value,
      client_address: document.getElementById('edit_clientAddress').value,
      matter_type: document.getElementById('edit_matterType').value,
      attorney: document.getElementById('edit_attorney').value,
      assigned_to: document.getElementById('edit_assignTo').value || null,
      matter_description: document.getElementById('edit_matterDescription').value,
      adverse_party: document.getElementById('edit_adverseParty').value,
      fee_type: document.querySelector('input[name="editFeeType"]:checked').value,
      hourly_rate: document.getElementById('edit_hourlyRate').value,
      paralegal_rate: document.getElementById('edit_paralegalRate').value,
      flat_fee_amount: document.getElementById('edit_flatFeeAmount').value,
      retainer_amount: document.querySelector('input[name="editFeeType"]:checked').value === 'Subscription'
        ? document.getElementById('edit_monthlyFee').value
        : document.getElementById('edit_retainerAmount').value,
      engagement_date: document.getElementById('edit_engagementDate').value,
      conflicts: document.getElementById('edit_conflicts').value,
      specialist_involved: document.getElementById('edit_specialistInvolved').value,
      specialist_name: document.getElementById('edit_specialistName').value,
      fee_sharing_details: document.getElementById('edit_feeSharingDetails').value,
      referral_source: document.getElementById('edit_referralSource').value,
      priority: document.getElementById('edit_priority').value,
      internal_notes: document.getElementById('edit_internalNotes').value,
    };

    const { error } = await db.from('clients').update(updates).eq('id', _editClientId);
    if (error) throw error;

    closeEditClientModal();
    renderDashboard();
    showStatus('Client record updated.', 'success');
  } catch (e) {
    showStatus('Error saving: ' + e.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
  }
}

function switchTab(t,btn){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab-'+t).classList.add('active');if(btn)btn.classList.add('active');if(t==='dashboard')renderDashboard();}

async function updateTrackerCount(){const c=await getClients();document.getElementById('trackerCount').textContent=c.length;}

const feeRadios=document.querySelectorAll('input[name="feeType"]');
const feeLabels=document.querySelectorAll('.fee-toggle label');
feeRadios.forEach(r=>{r.addEventListener('change',()=>{feeLabels.forEach(l=>l.classList.remove('active'));r.nextElementSibling.classList.add('active');const v=r.value;document.getElementById('hourlyRateGroup').classList.toggle('visible',v==='Hourly'||v==='Hybrid');document.getElementById('paralegalRateGroup').classList.toggle('visible',v==='Hourly'||v==='Hybrid');document.getElementById('flatFeeGroup').classList.toggle('visible',v==='Flat Fee'||v==='Hybrid');document.getElementById('monthlyFeeGroup').classList.toggle('visible',v==='Subscription');});});
document.getElementById('specialistInvolved').addEventListener('change',e=>{document.getElementById('specialistFields').classList.toggle('visible',e.target.value==='Yes');});
document.getElementById('engagementDate').valueAsDate=new Date();

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
// Escape Slack mrkdwn special chars to prevent formatting injection
function escSlack(s){return String(s||'').replace(/[&<>*_~`|]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','*':'\\*','_':'\\_','~':'\\~','`':'\\`','|':'\\|'})[c]||c);}

// Send Slack notification via Supabase Edge Function (webhook URL stays server-side)
async function notifySlack(payload) {
  let session = (await db.auth.getSession()).data.session;
  if (!session) return;

  // Refresh session if access token expires within 2 minutes (avoids stale-token 401s)
  const nowSec = Math.floor(Date.now() / 1000);
  if (session.expires_at && (session.expires_at - nowSec) < 120) {
    const { data, error: refreshErr } = await db.auth.refreshSession();
    if (refreshErr || !data.session) {
      throw new Error('Session expired — please sign in again.');
    }
    session = data.session;
  }

  // Direct fetch to bypass client header issues
  const res = await fetch(`${SUPABASE_URL}/functions/v1/slack-notify`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_ANON_KEY,
      'Authorization': `Bearer ${session.access_token}`
    },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    const msg = err.error || `Slack notify failed (${res.status})`;
    if (res.status === 401) {
      throw new Error('Authentication error — try signing out and back in.');
    }
    throw new Error(msg);
  }
}

// Sanitize HTML to only allow safe formatting tags (prevents stored XSS)
function sanitizeHtml(html) {
  const ALLOWED_TAGS = new Set(['b','i','u','strong','em','div','br','p','span']);
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  function walk(node) {
    const children = Array.from(node.childNodes);
    for (const child of children) {
      if (child.nodeType === Node.TEXT_NODE) continue;
      if (child.nodeType === Node.ELEMENT_NODE) {
        const tag = child.tagName.toLowerCase();
        if (!ALLOWED_TAGS.has(tag)) {
          // Replace disallowed element with its text content
          const text = document.createTextNode(child.textContent);
          node.replaceChild(text, child);
        } else {
          // Strip all attributes except safe ones (none needed for formatting)
          while (child.attributes.length > 0) {
            child.removeAttribute(child.attributes[0].name);
          }
          walk(child);
        }
      } else {
        // Remove comments and other node types
        node.removeChild(child);
      }
    }
  }
  walk(tmp);
  // Defense-in-depth: reject output if dangerous patterns somehow survived
  const out = tmp.innerHTML;
  if (/\bon\w+\s*=/i.test(out) || /javascript\s*:/i.test(out)) {
    return out.replace(/<[^>]*>/g, '');
  }
  return out;
}

function textToEditorHtml(text){
  if(/<\/?(?:b|i|u|strong|em|div|br|p|span)\b/i.test(text)) return sanitizeHtml(text);
  return esc(text).replace(/\n/g,'<br>');
}

function showStatus(m,t='success'){const b=document.getElementById('statusBar');document.getElementById('statusText').textContent=m;b.className='status-bar visible '+t;const ms=t==='error'?6000:m.length>60?5000:4000;setTimeout(()=>b.classList.remove('visible'),ms);}

function getFormData(){return{clientType:document.getElementById('clientType').value,entityName:document.getElementById('entityName').value,contactName:document.getElementById('contactName').value,contactTitle:document.getElementById('contactTitle').value,clientEmail:document.getElementById('clientEmail').value,clientPhone:document.getElementById('clientPhone').value,clientAddress:document.getElementById('clientAddress').value,matterType:document.getElementById('matterType').value,attorney:document.getElementById('attorney').value,assignTo:document.getElementById('assignTo').value,matterDescription:document.getElementById('matterDescription').value,adverseParty:document.getElementById('adverseParty').value,feeType:document.querySelector('input[name="feeType"]:checked').value,hourlyRate:document.getElementById('hourlyRate').value,paralegalRate:document.getElementById('paralegalRate').value,flatFeeAmount:document.getElementById('flatFeeAmount').value,monthlyFee:document.getElementById('monthlyFee').value,retainerAmount:document.getElementById('retainerAmount').value,engagementDate:document.getElementById('engagementDate').value,conflicts:document.getElementById('conflicts').value,specialistInvolved:document.getElementById('specialistInvolved').value,specialistName:document.getElementById('specialistName').value,feeSharingDetails:document.getElementById('feeSharingDetails').value,referralSource:document.getElementById('referralSource').value,priority:document.getElementById('priority').value,internalNotes:document.getElementById('internalNotes').value};}

function validateForm(){const r=document.querySelectorAll('#intakeForm [required]');let v=true;r.forEach(el=>{if(!el.value){el.style.borderColor='#C0392B';v=false;}else{el.style.borderColor='';}});if(!v)showStatus('Please fill in all required fields.','error');return v;}

function resetForm(){document.getElementById('intakeForm').reset();document.querySelectorAll('#intakeForm [required]').forEach(el=>el.style.borderColor='');feeLabels.forEach(l=>l.classList.remove('active'));document.querySelector('label[for="feeHourly"]').classList.add('active');document.getElementById('hourlyRateGroup').classList.add('visible');document.getElementById('paralegalRateGroup').classList.add('visible');document.getElementById('flatFeeGroup').classList.remove('visible');document.getElementById('monthlyFeeGroup').classList.remove('visible');document.getElementById('specialistFields').classList.remove('visible');document.getElementById('assignTo').value='';document.getElementById('engagementDate').valueAsDate=new Date();}

function formatDate(s){if(!s)return'';const d=new Date(s+'T00:00:00');return d.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}
function clientDisplayName(d){return d.entity_name||d.contact_name||d.entityName||d.contactName||'Unknown';}

function setDashFilter(filter, btn) {
  _dashFilter = filter;
  document.querySelectorAll('.dash-filter-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderDashboard();
}

function getAttyShortName(name) {
  if (!name) return '';
  return name.split(',')[0].split(' ').pop() || name.split(',')[0];
}

async function renderDashboard() {
  const allClients = await getClients();
  updateTrackerCount();

  // Fetch latest letter approval status per client
  let letterStatusMap = {};
  try {
    const clientIds = allClients.map(c => c.id);
    if (clientIds.length > 0) {
      const { data: letters } = await db.from('engagement_letters')
        .select('id, client_id, approval_status, reviewed_by, review_notes, assigned_reviewer, created_at, esign_status, signed_pdf_path')
        .in('client_id', clientIds)
        .order('created_at', { ascending: false });
      if (letters) {
        letters.forEach(l => {
          if (!letterStatusMap[l.client_id]) {
            letterStatusMap[l.client_id] = l;
          }
        });
      }
    }
  } catch (e) { /* table may not exist yet */ }

  // Determine current user's attorney name for filtering
  const userEmail = currentUser ? currentUser.email : '';
  const userAttyName = matchUserToAttorney(userEmail);

  // Apply filter
  let clients = allClients;
  if (_dashFilter === 'mine') {
    clients = allClients.filter(c => c.user_id === currentUser.id);
  } else if (_dashFilter === 'assigned') {
    clients = allClients.filter(c => {
      const assignedName = c.assigned_to || '';
      return assignedName && (assignedName === userAttyName || c.user_id !== currentUser.id);
    });
  } else if (_dashFilter === 'review') {
    // Show only letters assigned to the current user for review
    clients = allClients.filter(c => {
      const ls = letterStatusMap[c.id];
      return ls && ls.approval_status === 'Pending Review' && ls.assigned_reviewer === userAttyName;
    });
  }

  const t = allClients.length;
  const p = allClients.filter(c => c.status === 'Prospective').length;
  const pr = Object.values(letterStatusMap).filter(l => l.approval_status === 'Pending Review' && l.assigned_reviewer === userAttyName).length;
  const ap = Object.values(letterStatusMap).filter(l => l.approval_status === 'Approved').length;
  const s = allClients.filter(c => c.status === 'Letter Sent').length;
  const e = allClients.filter(c => c.status === 'Executed').length;

  document.getElementById('statsRow').innerHTML =
    `<div class="stat-card"><div class="stat-num">${t}</div><div class="stat-label">Total</div></div>` +
    `<div class="stat-card"><div class="stat-num">${p}</div><div class="stat-label">Prospective</div></div>` +
    `<div class="stat-card${pr > 0 ? ' stat-alert' : ''}"><div class="stat-num">${pr}</div><div class="stat-label">Needs My Review</div></div>` +
    `<div class="stat-card"><div class="stat-num">${ap}</div><div class="stat-label">Approved</div></div>` +
    `<div class="stat-card"><div class="stat-num">${s}</div><div class="stat-label">Letter Sent</div></div>` +
    `<div class="stat-card"><div class="stat-num">${e}</div><div class="stat-label">Executed</div></div>`;

  if (!clients.length) {
    const msg = _dashFilter === 'all' ? 'No clients yet.' :
      _dashFilter === 'mine' ? 'No matters created by you.' :
      _dashFilter === 'assigned' ? 'No matters assigned to you.' :
      'No letters pending review.';
    document.getElementById('trackerTableContainer').innerHTML = `<div class="empty-state"><p>${msg}</p></div>`;
    return;
  }

  const sc = s => ({ Prospective:'status-prospective', 'Letter Sent':'status-sent', Executed:'status-executed', Declined:'status-declined' }[s] || '');
  const approvalClass = s => ({ Draft:'approval-draft', 'Pending Review':'approval-pending', Approved:'approval-approved', 'Changes Requested':'approval-changes', Executed:'approval-executed' }[s] || 'approval-draft');

  const rows = clients.map(c => {
    const ls = letterStatusMap[c.id];
    const letterStatus = ls ? ls.approval_status || 'Draft' : '\u2014';
    const esignPill = ls && ls.esign_status ? ` <span class="approval-pill" style="background:${ls.esign_status === 'completed' ? '#E8F5E9;color:#2E7D32' : ls.esign_status === 'declined' ? '#FFEBEE;color:#C62828' : '#FFF8E1;color:#E6A817'};font-size:9px;padding:2px 7px;${ls.signed_pdf_path ? 'cursor:pointer;text-decoration:underline;' : ''}" ${ls.signed_pdf_path ? `onclick="downloadSignedCopy('${esc(ls.id)}','${esc(ls.signed_pdf_path)}')" title="Download signed copy"` : ''}>${esc(ls.esign_status === 'completed' ? 'Signed' : ls.esign_status === 'sent' ? 'E-Sign Pending' : ls.esign_status)}${ls.signed_pdf_path ? ' \u2193' : ''}</span>` : '';
    const letterPill = ls ? `<span class="approval-pill ${approvalClass(letterStatus)}">${esc(letterStatus)}</span>${esignPill}` : `<span style="color:var(--warm-gray);font-size:11px">\u2014</span>`;
    const assignedShort = c.assigned_to ? getAttyShortName(c.assigned_to) : '';
    const assignedHtml = assignedShort ? `<span class="assigned-badge has-assignee">${esc(assignedShort)}</span>` : `<span style="color:var(--warm-gray);font-size:11px">\u2014</span>`;

    return `<tr>
      <td style="font-weight:600">${esc(clientDisplayName(c))}</td>
      <td>${esc(c.matter_type || '')}</td>
      <td>${esc(c.attorney ? c.attorney.split(',')[0] : '')}</td>
      <td>${assignedHtml}</td>
      <td>${c.engagement_date ? esc(formatDate(c.engagement_date)) : ''}</td>
      <td><span class="status-pill ${sc(c.status)}">${esc(c.status)}</span></td>
      <td>${letterPill}</td>
      <td><div class="row-actions">
        <select onchange="updateClientStatus('${esc(c.id)}',this.value)">
          <option value="Prospective" ${c.status === 'Prospective' ? 'selected' : ''}>Prospective</option>
          <option value="Letter Sent" ${c.status === 'Letter Sent' ? 'selected' : ''}>Letter Sent</option>
          <option value="Executed" ${c.status === 'Executed' ? 'selected' : ''}>Executed</option>
          <option value="Declined" ${c.status === 'Declined' ? 'selected' : ''}>Declined</option>
        </select>
        <button onclick="editClient('${esc(c.id)}')" title="Edit Matter">\u270E</button>
        <button onclick="viewLetterHistory('${esc(c.id)}')" title="Document History">\ud83d\udcc4</button>
        <button onclick="regenLetter('${esc(c.id)}')" title="Regenerate Letter">\ud83d\udd04</button>
        <button class="del" onclick="deleteClient('${esc(c.id)}')" title="Delete">\u2715</button>
      </div></td>
    </tr>`;
  }).join('');

  document.getElementById('trackerTableContainer').innerHTML =
    `<table class="tracker-table"><thead><tr>
      <th>Client</th><th>Matter</th><th>Attorney</th><th>Assigned</th><th>Date</th><th>Status</th><th>Letter</th><th>Actions</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
}

function matchUserToAttorney(email) {
  if (!email) return '';
  // Match on the local part (before @) to avoid false positives
  const local = email.toLowerCase().split('@')[0];
  if (local === 'matthew' || local === 'matt') return 'Matt A. Margolis, Esq.';
  if (local === 'karina') return 'Karina Margolis, Esq.';
  if (local === 'jen' || local === 'jhealy') return 'Jen Healy, Esq.';
  if (local === 'hunter' || local === 'hsutherland') return 'Hunter Sutherland, Esq.';
  return '';
}

// =============================================
// APPROVAL WORKFLOW FUNCTIONS
// =============================================

async function submitForReview() {
  if (!_letterClientId) { showStatus('No client linked to this letter.', 'error'); return; }

  // Require reviewer selection
  const reviewerSelect = document.getElementById('reviewerSelect');
  const assignedReviewer = reviewerSelect ? reviewerSelect.value : '';
  if (!assignedReviewer) {
    showStatus('Please select a reviewer before submitting.', 'error');
    if (reviewerSelect) reviewerSelect.focus();
    return;
  }

  // Disable button to prevent double-clicks
  const submitBtn = document.querySelector('.btn-submit-review');
  if (submitBtn) submitBtn.disabled = true;

  // Save letter first if not saved, or update existing
  let letterId = _letterApprovalId || _lastSavedLetterId;
  if (!letterId) {
    letterId = await saveLetterToDb('Pending Review', assignedReviewer);
  } else {
    try {
      const { error } = await db.from('engagement_letters')
        .update({ approval_status: 'Pending Review', assigned_reviewer: assignedReviewer, reviewed_by: null, reviewed_at: null, review_notes: null })
        .eq('id', letterId);
      if (error) throw error;
    } catch (e) { showStatus('Error: ' + e.message, 'error'); if (submitBtn) submitBtn.disabled = false; return; }
  }

  if (!letterId) { showStatus('Could not save letter. Check your connection and try again.', 'error'); if (submitBtn) submitBtn.disabled = false; return; }

  _letterApprovalStatus = 'Pending Review';
  _letterApprovalId = letterId;
  _lastSavedLetterId = letterId;
  _letterAssignedReviewer = assignedReviewer;
  updateApprovalBar();
  showStatus(`\u2713 Letter submitted for review by ${assignedReviewer}.`, 'success');

  // Send Slack notification if configured
  if (isSlackEnabled() && _letterReviewMeta) {
    const meta = _letterReviewMeta;
    const baseUrl = window.location.origin + window.location.pathname;
    const letterLink = letterId ? `${baseUrl}?letter=${letterId}` : baseUrl;
    const sentBy = currentUser ? currentUser.email : 'unknown';

    try {
      const blocks = [
        { type: 'header', text: { type: 'plain_text', text: `${escSlack(assignedReviewer)}: Letter Needs Your Approval`, emoji: true } },
        { type: 'section', fields: [
          { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
          { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` }
        ]},
        { type: 'section', fields: [
          { type: 'mrkdwn', text: `*Attorney:*\n${escSlack(meta.atty)}` },
          { type: 'mrkdwn', text: `*Submitted by:*\n${escSlack(sentBy)}` }
        ]},
        { type: 'actions', elements: [
          { type: 'button', text: { type: 'plain_text', text: 'Review & Approve in Intakr', emoji: true }, url: letterLink, style: 'primary' }
        ]}
      ];
      await notifySlack({
        text: `<!here> ${escSlack(assignedReviewer)}: Letter needs your approval — ${escSlack(meta.name)} - ${escSlack(meta.matter)} (from ${escSlack(sentBy)})`,
        blocks
      });
    } catch (e) { /* Slack notification is best-effort */ }
  }
}

async function approveLetter() {
  if (!confirm('Approve this engagement letter?')) return;

  // Disable buttons to prevent double-clicks
  const approveBtn = document.querySelector('.btn-approve');
  const sendBackBtn = document.querySelector('.btn-send-back');
  if (approveBtn) approveBtn.disabled = true;
  if (sendBackBtn) sendBackBtn.disabled = true;

  // Try to save first if no letter ID exists
  if (!_letterApprovalId && _letterClientId) {
    const savedId = await saveLetterToDb('Pending Review');
    if (savedId) _letterApprovalId = savedId;
  }
  if (!_letterApprovalId) { showStatus('Letter must be saved before it can be approved. Try saving as draft first.', 'error'); if (approveBtn) approveBtn.disabled = false; if (sendBackBtn) sendBackBtn.disabled = false; return; }

  // Prevent self-approval UNLESS the letter has already been through a review cycle
  // (i.e., another attorney already reviewed it and sent it back with changes)
  try {
    const { data: letterData, error: fetchErr } = await db.from('engagement_letters')
      .select('created_by_email, reviewed_by')
      .eq('id', _letterApprovalId)
      .single();
    if (fetchErr) throw fetchErr;
    const isAuthor = letterData && letterData.created_by_email === currentUser.email;
    const wasReviewedByOther = letterData && letterData.reviewed_by && letterData.reviewed_by !== currentUser.email;
    if (isAuthor && !wasReviewedByOther) {
      showStatus('You cannot approve your own letter. Another attorney must review it first.', 'error');
      if (approveBtn) approveBtn.disabled = false; if (sendBackBtn) sendBackBtn.disabled = false;
      return;
    }
  } catch (e) {
    showStatus('Could not verify letter ownership. Please try again.', 'error');
    if (approveBtn) approveBtn.disabled = false; if (sendBackBtn) sendBackBtn.disabled = false;
    return;
  }

  try {
    const { error } = await db.from('engagement_letters')
      .update({
        approval_status: 'Approved',
        reviewed_by: currentUser.email,
        reviewed_at: new Date().toISOString()
      })
      .eq('id', _letterApprovalId);
    if (error) throw error;

    _letterApprovalStatus = 'Approved';
    updateApprovalBar();
    showStatus('Letter approved!', 'success');

    // Slack notification
    if (isSlackEnabled() && _letterReviewMeta) {
      const meta = _letterReviewMeta;
      const approverName = matchUserToAttorney(currentUser.email) || currentUser.email;
      try {
        await notifySlack({
          text: `Letter approved: ${escSlack(meta.name)} - ${escSlack(meta.matter)}`,
          blocks: [
            { type: 'header', text: { type: 'plain_text', text: 'Letter Approved', emoji: true } },
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
              { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` }
            ]},
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Approved by:*\n${escSlack(approverName)}` }
            ]}
          ]
        });
      } catch (e) { /* best-effort */ }
    }
  } catch (e) {
    showStatus('Error: ' + e.message, 'error');
    if (approveBtn) approveBtn.disabled = false; if (sendBackBtn) sendBackBtn.disabled = false;
  }
}

function showSendBackNotesUI() {
  // Prevent self-review BEFORE showing the UI — check the ORIGINAL letter's author
  const originalId = _letterApprovalId;
  if (!originalId) { showStatus('Letter must be saved before it can be reviewed.', 'error'); return; }

  db.from('engagement_letters').select('created_by_email, reviewed_by').eq('id', originalId).single()
    .then(({ data }) => {
      const isAuthor = data && data.created_by_email === currentUser.email;
      const wasReviewedByOther = data && data.reviewed_by && data.reviewed_by !== currentUser.email;
      if (isAuthor && !wasReviewedByOther) {
        showStatus('You cannot review your own letter. Another attorney must review it first.', 'error');
        return;
      }
      // Show inline notes area in the approval bar
      const bar = document.getElementById('approvalBarContainer');
      if (!bar) return;
      const existing = document.getElementById('sendBackNotesArea');
      if (existing) { existing.querySelector('textarea').focus(); return; }
      const notesHtml = `<div id="sendBackNotesArea" style="margin-top:12px;padding:14px 16px;background:#FFF5F5;border:1px solid #ECC;border-radius:8px;">
        <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px;">Notes for the submitter:</label>
        <textarea id="sendBackNotes" rows="3" placeholder="Describe what you changed or what still needs work..." style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end;">
          <button class="btn btn-sm" onclick="document.getElementById('sendBackNotesArea').remove()" style="background:var(--light-gray);color:var(--dark);">Cancel</button>
          <button class="btn btn-sm btn-send-back" onclick="confirmSendBack()">Send Back</button>
        </div>
      </div>`;
      bar.insertAdjacentHTML('beforeend', notesHtml);
      document.getElementById('sendBackNotes').focus();
    })
    .catch(() => {
      showStatus('Could not verify letter ownership. Please try again.', 'error');
    });
}

async function confirmSendBack() {
  const textarea = document.getElementById('sendBackNotes');
  const notes = textarea ? textarea.value : '';
  if (!notes.trim()) { showStatus('Please provide notes explaining what needs to change.', 'error'); if (textarea) textarea.focus(); return; }

  // Disable button to prevent double-clicks
  const btns = document.querySelectorAll('#sendBackNotesArea button');
  btns.forEach(b => b.disabled = true);

  // Save the reviewer's edits as a new version BEFORE changing status
  // Remember the original letter's ID for the status update
  const originalLetterId = _letterApprovalId;

  if (_letterClientId) {
    const savedId = await saveLetterToDb('Changes Requested');
    if (savedId) _letterApprovalId = savedId;
  }
  if (!_letterApprovalId) { showStatus('Letter must be saved first. Try saving as draft.', 'error'); btns.forEach(b => b.disabled = false); return; }

  try {
    const { error } = await db.from('engagement_letters')
      .update({
        approval_status: 'Changes Requested',
        reviewed_by: currentUser.email,
        reviewed_at: new Date().toISOString(),
        review_notes: notes.trim()
      })
      .eq('id', _letterApprovalId);
    if (error) throw error;

    _letterApprovalStatus = 'Changes Requested';
    updateApprovalBar(notes.trim(), currentUser.email);
    showStatus('Letter sent back with your edits and notes.', 'success');

    // Slack notification
    if (isSlackEnabled() && _letterReviewMeta) {
      const meta = _letterReviewMeta;
      const reviewerName = matchUserToAttorney(currentUser.email) || currentUser.email;
      try {
        await notifySlack({
          text: `Letter sent back: ${escSlack(meta.name)} - ${escSlack(meta.matter)}`,
          blocks: [
            { type: 'header', text: { type: 'plain_text', text: 'Letter Sent Back for Revision', emoji: true } },
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Client:*\n${escSlack(meta.name)}` },
              { type: 'mrkdwn', text: `*Matter:*\n${escSlack(meta.matter)}` }
            ]},
            { type: 'section', fields: [
              { type: 'mrkdwn', text: `*Reviewed by:*\n${escSlack(reviewerName)}` },
              { type: 'mrkdwn', text: `*Notes:*\n${escSlack(notes.trim())}` }
            ]}
          ]
        });
      } catch (e) { /* best-effort */ }
    }
  } catch (e) {
    showStatus('Error: ' + e.message, 'error');
    btns.forEach(b => b.disabled = false);
  }
}

async function saveDraft() {
  if (!_letterClientId) { showStatus('No client linked.', 'error'); return; }
  // Preserve current approval status when saving — don't reset Pending Review or Approved
  const preserveStatus = _letterApprovalStatus === 'Pending Review' || _letterApprovalStatus === 'Approved';
  const saveStatus = preserveStatus ? _letterApprovalStatus : 'Draft';
  const letterId = await saveLetterToDb(saveStatus);
  if (letterId) {
    _letterApprovalStatus = saveStatus;
    _letterApprovalId = letterId;
    updateApprovalBar();
    showStatus('\u2713 Draft saved.', 'success');
  }
}

function getReviewerOptions() {
  const attorneys = [
    'Matt A. Margolis, Esq.',
    'Karina Margolis, Esq.',
    'Jen Healy, Esq.',
    'Hunter Sutherland, Esq.'
  ];
  // Exclude current user
  const currentAtty = currentUser ? matchUserToAttorney(currentUser.email) : '';
  return attorneys.filter(a => a !== currentAtty);
}

function updateApprovalBar(reviewNotes, reviewedBy) {
  const bar = document.getElementById('approvalBarContainer');
  if (!bar) return;

  const status = _letterApprovalStatus || 'Draft';
  const barClass = {
    Draft: 'bar-draft',
    'Pending Review': 'bar-pending',
    Approved: 'bar-approved',
    'Changes Requested': 'bar-changes',
    Executed: 'bar-executed'
  }[status] || 'bar-draft';

  let html = `<div class="approval-bar ${barClass}">`;

  // --- Top row: status text + action buttons ---
  html += `<div class="approval-top-row">`;
  html += `<div class="approval-status-text">`;

  if (status === 'Draft') {
    html += `Status: Draft`;
    html += `<small>Designate a reviewer below, then submit for approval.</small>`;
  } else if (status === 'Pending Review') {
    html += `Status: Pending Review`;
    const reviewer = _letterAssignedReviewer;
    const isReviewer = currentUser && reviewer && (matchUserToAttorney(currentUser.email) === reviewer);
    if (isReviewer) {
      html += `<small>This letter is awaiting your approval.</small>`;
    } else {
      html += `<small>Sent to ${reviewer ? esc(reviewer) : 'reviewer'} for approval.</small>`;
    }
  } else if (status === 'Approved') {
    html += `Status: Approved`;
    if (reviewedBy) html += `<small>Approved by ${esc(reviewedBy)}</small>`;
  } else if (status === 'Executed') {
    html += `Status: Executed`;
    html += `<small>This engagement letter has been fully signed and executed.</small>`;
  } else if (status === 'Changes Requested') {
    html += `Status: Sent Back`;
    if (reviewedBy) html += `<small>Returned by ${esc(reviewedBy)} &mdash; see notes below. Edit the letter and resubmit.</small>`;
  }

  html += `</div><div class="approval-actions">`;

  if (status === 'Draft' || status === 'Changes Requested') {
    html += `<button class="btn btn-sm btn-submit-review" onclick="submitForReview()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg> Submit for Approval</button>`;
  }
  if (status === 'Pending Review') {
    html += `<button class="btn btn-sm btn-approve" onclick="approveLetter()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Approve</button>`;
    html += `<button class="btn btn-sm btn-send-back" onclick="showSendBackNotesUI()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14l-4-4 4-4"/><path d="M5 10h11a4 4 0 0 1 0 8h-1"/></svg> Send Back with Edits</button>`;
  }

  html += `</div></div>`; // close top-row

  // --- Reviewer picker row (Draft / Changes Requested) ---
  if (status === 'Draft' || status === 'Changes Requested') {
    const options = getReviewerOptions();
    const selected = _letterAssignedReviewer || '';
    html += `<div class="reviewer-row">`;
    html += `<label>Assign Reviewer:</label>`;
    html += `<select id="reviewerSelect" class="reviewer-select">`;
    html += `<option value="">Choose who will review...</option>`;
    options.forEach(name => {
      html += `<option value="${esc(name)}" ${name === selected ? 'selected' : ''}>${esc(name)}</option>`;
    });
    html += `</select>`;
    html += `</div>`;
  }

  html += `</div>`; // close approval-bar

  // Show review notes if status is Changes Requested
  if (status === 'Changes Requested' && reviewNotes) {
    html += `<div class="review-notes-box"><strong>Reviewer Notes</strong>${esc(reviewNotes)}</div>`;
  }

  bar.innerHTML = html;
}

const XH=['Date','Client','Entity','Type','Contact','Email','Phone','Matter','Description','Attorney','Assigned To','Fee Type','Rate','Retainer','Adverse','Conflicts','Specialist','Referral','Priority','Status','Letter Sent','Executed','Notes'];
function ctr(c){const r=c.fee_type==='Hourly'?`${c.hourly_rate}/hr`:c.fee_type==='Flat Fee'?`Flat: ${c.flat_fee_amount}`:c.fee_type==='Subscription'?`Sub: ${c.retainer_amount}/mo`:`${c.hourly_rate}/hr + Flat: ${c.flat_fee_amount}`;return[c.engagement_date?formatDate(c.engagement_date):'',clientDisplayName(c),c.entity_name,c.client_type,c.contact_name,c.client_email,c.client_phone,c.matter_type,c.matter_description,c.attorney,c.assigned_to||'',c.fee_type,r,c.retainer_amount,c.adverse_party,c.conflicts,c.specialist_involved==='Yes'?c.specialist_name:'N/A',c.referral_source,c.priority,c.status||'Prospective',c.letter_sent||'',c.letter_executed||'',c.internal_notes];}

async function exportMasterExcel(){const c=await getClients();if(!c.length){showStatus('No data.','error');return;}const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([XH,...c.map(ctr)]),'Tracker');XLSX.writeFile(wb,`Intakr_Master_${new Date().toISOString().slice(0,10)}.xlsx`);showStatus(`\u2713 Exported ${c.length} client(s).`,'success');}
function exportSingleClientExcel(d){const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([XH,ctr(d)]),'Client');XLSX.writeFile(wb,`Intakr_${clientDisplayName(d).replace(/[^a-zA-Z0-9]/g,'_')}.xlsx`);}

// =============================================
// ENGAGEMENT LETTER — REVIEW & EDIT FLOW
// =============================================

// Stored state for the current review session
let _letterReviewMeta = null;
let _letterReviewSections = null;
let _letterClientId = null;
let _letterSavedThisSession = false;

/*
 * =============================================
 * SUPABASE MIGRATION — DOCUMENT STORAGE
 * =============================================
 * Run this SQL in the Supabase SQL Editor (Dashboard > SQL Editor) to enable document storage:
 *
 * CREATE TABLE engagement_letters (
 *   id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
 *   client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
 *   user_id UUID NOT NULL,
 *   version INTEGER NOT NULL DEFAULT 1,
 *   letter_data JSONB NOT NULL,
 *   file_name TEXT NOT NULL,
 *   created_by_email TEXT,
 *   approval_status TEXT DEFAULT 'Draft',
 *   reviewed_by TEXT,
 *   reviewed_at TIMESTAMPTZ,
 *   review_notes TEXT,
 *   created_at TIMESTAMPTZ DEFAULT NOW()
 * );
 *
 * ALTER TABLE engagement_letters ENABLE ROW LEVEL SECURITY;
 *
 * CREATE POLICY "Users can view own letters"
 *   ON engagement_letters FOR SELECT
 *   USING (auth.uid() = user_id);
 *
 * CREATE POLICY "Users can insert own letters"
 *   ON engagement_letters FOR INSERT
 *   WITH CHECK (auth.uid() = user_id);
 *
 * CREATE POLICY "Users can update own letters"
 *   ON engagement_letters FOR UPDATE
 *   USING (auth.uid() = user_id);
 *
 * CREATE POLICY "Users can delete own letters"
 *   ON engagement_letters FOR DELETE
 *   USING (auth.uid() = user_id);
 *
 * CREATE INDEX idx_engagement_letters_client ON engagement_letters(client_id);
 * CREATE INDEX idx_engagement_letters_user ON engagement_letters(user_id);
 *
 * =============================================
 * MIGRATION — ASSIGN TO + SHARED VISIBILITY
 * =============================================
 * Run this SQL to add assignment columns and enable shared visibility.
 * We use assigned_to_user_id (UUID) for RLS and assigned_to (TEXT) for display.
 *
 * ALTER TABLE clients ADD COLUMN IF NOT EXISTS assigned_to TEXT;
 * ALTER TABLE clients ADD COLUMN IF NOT EXISTS assigned_to_user_id UUID;
 *
 * -- To enable cross-user visibility for assigned matters,
 * -- update the RLS SELECT policy on clients (uses UUID, not name):
 *
 * DROP POLICY IF EXISTS "Users can view own clients" ON clients;
 * CREATE POLICY "Users can view own or assigned clients"
 *   ON clients FOR SELECT
 *   USING (auth.uid() = user_id OR auth.uid() = assigned_to_user_id);
 *
 * DROP POLICY IF EXISTS "Users can update own clients" ON clients;
 * CREATE POLICY "Users can update own or assigned clients"
 *   ON clients FOR UPDATE
 *   USING (auth.uid() = user_id OR auth.uid() = assigned_to_user_id);
 *
 * -- Also update engagement_letters RLS so assigned users can view/update letters:
 *
 * DROP POLICY IF EXISTS "Users can view own letters" ON engagement_letters;
 * CREATE POLICY "Users can view own or assigned letters"
 *   ON engagement_letters FOR SELECT
 *   USING (
 *     auth.uid() = user_id
 *     OR EXISTS (
 *       SELECT 1 FROM clients
 *       WHERE clients.id = engagement_letters.client_id
 *       AND auth.uid() = clients.assigned_to_user_id
 *     )
 *   );
 *
 * DROP POLICY IF EXISTS "Users can update own letters" ON engagement_letters;
 * CREATE POLICY "Users can update own or assigned letters"
 *   ON engagement_letters FOR UPDATE
 *   USING (
 *     auth.uid() = user_id
 *     OR EXISTS (
 *       SELECT 1 FROM clients
 *       WHERE clients.id = engagement_letters.client_id
 *       AND auth.uid() = clients.assigned_to_user_id
 *     )
 *   );
 *
 * =============================================
 * MIGRATION — APPROVAL WORKFLOW (if table already exists)
 * =============================================
 * If you already created the engagement_letters table, run these to add approval columns:
 *
 * ALTER TABLE engagement_letters ADD COLUMN IF NOT EXISTS approval_status TEXT DEFAULT 'Draft';
 * ALTER TABLE engagement_letters ADD COLUMN IF NOT EXISTS reviewed_by TEXT;
 * ALTER TABLE engagement_letters ADD COLUMN IF NOT EXISTS reviewed_at TIMESTAMPTZ;
 * ALTER TABLE engagement_letters ADD COLUMN IF NOT EXISTS review_notes TEXT;
 * ALTER TABLE engagement_letters ADD COLUMN IF NOT EXISTS assigned_reviewer TEXT;
 *
 * =============================================
 * MIGRATION — REVIEWER ACCESS (RLS)
 * =============================================
 * Reviewers need to view and update letters from other users.
 * Run this to allow all authenticated firm users to view and review letters:
 *
 * DROP POLICY IF EXISTS "Users can view own letters" ON engagement_letters;
 * DROP POLICY IF EXISTS "Users can view own or assigned letters" ON engagement_letters;
 * CREATE POLICY "Firm users can view all letters"
 *   ON engagement_letters FOR SELECT
 *   USING (auth.role() = 'authenticated');
 *
 * DROP POLICY IF EXISTS "Users can update own letters" ON engagement_letters;
 * DROP POLICY IF EXISTS "Users can update own or assigned letters" ON engagement_letters;
 * CREATE POLICY "Firm users can update all letters"
 *   ON engagement_letters FOR UPDATE
 *   USING (auth.role() = 'authenticated');
 *
 * =============================================
 */

// Save the current letter to Supabase (called on download/Slack send)
let _lastSavedLetterId = null;

async function saveLetterToDb(approvalStatus, assignedReviewer) {
  if (!_letterReviewMeta || !_letterReviewSections || !_letterClientId) return null;
  // Capture references before any async work (modal close can null these)
  const meta = _letterReviewMeta;
  const sections = _letterReviewSections;
  const clientId = _letterClientId;

  try {
    const headerData = {
      date: document.getElementById('rev_date')?.value || '',
      recipient: document.getElementById('rev_recipient')?.value || '',
      attention: document.getElementById('rev_attention')?.value || '',
      email: document.getElementById('rev_email')?.value || '',
      re: document.getElementById('rev_re')?.value || '',
      greeting: document.getElementById('rev_greeting')?.value || '',
    };

    const editedSections = sections.map(s => ({
      id: s.id,
      label: s.label,
      text: sanitizeHtml(document.getElementById('rev_' + s.id)?.innerHTML || s.text),
    }));

    const letterData = { meta, header: headerData, sections: editedSections };

    // If we already have a saved letter ID and no approval status change,
    // update the existing record instead of creating a new version
    if (_lastSavedLetterId && !approvalStatus) {
      const { error: updateError } = await db.from('engagement_letters')
        .update({ letter_data: letterData })
        .eq('id', _lastSavedLetterId);
      if (!updateError) {
        _letterApprovalId = _lastSavedLetterId;
        return _lastSavedLetterId;
      }
      // If update fails, fall through to insert a new version
    }

    // Determine next version number for this client
    const { data: existing } = await db.from('engagement_letters')
      .select('version')
      .eq('client_id', clientId)
      .order('version', { ascending: false })
      .limit(1);

    const nextVersion = (existing && existing.length > 0) ? existing[0].version + 1 : 1;
    const fileName = `Engagement_Letter_${meta.name.replace(/[^a-zA-Z0-9]/g, '_')}_v${nextVersion}.docx`;

    const insertData = {
      client_id: clientId,
      user_id: currentUser.id,
      version: nextVersion,
      letter_data: letterData,
      file_name: fileName,
      created_by_email: currentUser.email,
    };
    if (approvalStatus) insertData.approval_status = approvalStatus;
    if (assignedReviewer) insertData.assigned_reviewer = assignedReviewer;

    const { data: inserted, error } = await db.from('engagement_letters')
      .insert([insertData]).select('id').single();

    if (error) throw error;
    _lastSavedLetterId = inserted ? inserted.id : null;
    _letterApprovalId = _lastSavedLetterId;
    return _lastSavedLetterId;
  } catch (e) {
    // Fail silently — table may not exist yet
    console.warn('Letter save skipped:', e.message);
    return null;
  }
}

function buildLetterSections(data) {
  const name = clientDisplayName(data);
  const contact = data.contact_name||data.contactName||'';
  const title = data.contact_title||data.contactTitle||'';
  const email = data.client_email||data.clientEmail||'';
  const matter = data.matter_type||data.matterType||'';
  const atty = data.attorney||'';
  const engDate = formatDate(data.engagement_date||data.engagementDate||'');
  const feeType = data.fee_type||data.feeType||'Hourly';
  const flat = data.flat_fee_amount||data.flatFeeAmount||'';
  const monthly = data.monthly_fee||data.monthlyFee||data.retainer_amount||data.retainerAmount||'';
  const matterDesc = data.matter_description||data.matterDescription||'';
  const isEntity = (data.client_type||data.clientType)==='Business Entity';
  const clientLabel = isEntity ? name : contact;

  let sigFull = '', sigShort = '';
  if (atty.includes('Matt')) { sigFull = 'Matt A. Margolis'; sigShort = 'Matt Margolis'; }
  else if (atty.includes('Karina')) { sigFull = 'Karina Margolis'; sigShort = 'Karina Margolis'; }
  else if (atty.includes('Jen')) { sigFull = 'Jen Healy'; sigShort = 'Jen Healy'; }
  else if (atty.includes('Hunter')) { sigFull = 'Hunter Sutherland'; sigShort = 'Hunter Sutherland'; }
  else { sigFull = 'Matt A. Margolis'; sigShort = 'Matt Margolis'; }

  let feeText = '';
  if (feeType === 'Hourly') {
    feeText = `Fees will be based upon our standard hourly rates. Our standard hourly rates are: Partner: $700/hour; Of Counsel: $600/hour; Associate: $500/hour; Paralegal: $250/hour, unless otherwise agreed in writing. Our rates may change periodically with 30 days\u2019 advance notice. Where possible, we may use attorneys and paralegals with lower hourly rates, without compromising the quality of representation. Upon request, we will provide an estimate of time required and potential costs before commencing legal work. Any estimate or range is not binding, is subject to periodic revision, and should not be construed as a promise or guarantee your matter can be concluded within the estimate or range of fees or costs.`;
  } else if (feeType === 'Flat Fee') {
    feeText = `Fees for this matter will be a pre-negotiated flat fee of ${flat} between the Client and the Firm (\u201cFlat Fee\u201d). The Flat Fee covers the scope of representation described above and does not include costs as described below.`;
  } else if (feeType === 'Subscription') {
    feeText = `If you elect for a subscription, which is a non-refundable retainer, fees will be ${monthly}. Our standard hourly rates are: Partner: $700/hour; Of Counsel: $600/hour; Associate: $500/hour; Paralegal: $250/hour, unless otherwise agreed in writing. Our rates may change periodically with 30 days\u2019 advance notice. Upon request, we will provide an estimate of time required and potential costs before commencing legal work outside the subscription. Any estimate or range, unless a Flat Fee or subscription arrangement, is not binding, is subject to periodic revision, and should not be construed as a promise or guarantee your matter can be concluded within the estimate or range of fees or costs.`;
  } else {
    feeText = `Fees will be based upon a combination of our standard hourly rates and a pre-negotiated flat fee. Our standard hourly rates are: Partner: $700/hour; Of Counsel: $600/hour; Associate: $500/hour; Paralegal: $250/hour, unless otherwise agreed in writing. Additionally, a flat fee of ${flat} has been agreed upon for certain defined portions of this engagement. Our rates may change periodically with 30 days\u2019 advance notice.`;
  }

  const meta = { name, contact, title, email, matter, atty, engDate, isEntity, clientLabel, sigFull, sigShort };

  const sections = [
    { id:'intro', label:'Introduction', text:`We are pleased that you seek to retain Margolis PLLC (the \u201cFirm\u201d, \u201cWe\u201d, \u201cOur\u201d or \u201cUs\u201d) to represent ${isEntity?name:'you'} (the \u201cClient\u201d or \u201cYou\u201d) in the above referenced matter. This engagement letter will govern the work to be performed by us as well as all other legal work (and related costs) accomplished by the Firm for the Client unless a different fee and cost arrangement for such work is agreed upon in writing by the parties.\n\nThis engagement letter, and the attached Exhibit A, describes the basis on which our Firm will provide legal services to the Client and bill for those services.` },
    { id:'s1', label:'1. Attorney in Charge', text:`I will be the \u201cAttorney in Charge.\u201d Other attorneys may become involved in assisting me in the Representation (as defined below), but please always feel free to contact me directly with any questions or comments you may have with respect to the Client\u2019s relationship with the Firm and the work being performed.` },
    { id:'s2', label:'2. Client', text:`You will be our only client in this matter. Unless we agree otherwise in writing, persons and entities related to you or sharing your interests including affiliated companies, owners, officers, directors, business partners, or family members are not our clients.` },
    { id:'s3', label:'3. Scope', text:`The scope of our engagement and duties to you will relate solely to the above referenced matter. However, please note that this scope does not include: (1) tax law; (2) patent law; (3) public securities; (4) ERISA; (5) family law; and (6) bankruptcy/creditors rights. Our acceptance of this engagement does not mean we represent you or your interests in other matters. Any expansion of our scope of work in this matter, and any representation of you in other matters, will be set forth in a separate letter or agreement. If we undertake to represent you in other matters without specific terms of engagement, the terms of this engagement letter will apply.` },
    { id:'s4', label:'4. What We Need From You', text:`Please keep us informed of developments that may affect the work we are doing for you. Also, we expect that you will commit sufficient resources to meet the demands of the matter and be available to attend meetings and necessary legal proceedings. Please provide us all documents and other information necessary for us to perform our work for you. We also ask that you promptly review and pay our invoices. Please ask us any questions you may have about our services or charges.` },
    { id:'s5', label:'5. Advice About Possible Outcomes', text:`During the course of our representation, we may advise you about various courses of action or results that might be obtained. That advice will be based on the information and circumstances known to us at the time. You should not regard our advice as a promise of what may happen in the future or a guarantee of future results.` },
    { id:'s6', label:'6. Legal Services Fees', text:feeText },
    { id:'s7', label:'7. Costs', text:`The Client agrees to pay all costs, including, but not limited to, items such as copy costs, messenger and delivery service, Westlaw, Lexis-Nexis, and/or Alexi research, travel (including mileage, parking, airfare, lodging, meals and ground transportation), court costs and filing fees. Unless special arrangements are made at the outset, fees and expenses of others (such as outside copy services, experts, investigators, witnesses, consultants and court reporters) will not be paid by us and will be the responsibility of, and billed directly to, you.` },
    { id:'s8', label:'8. Payment', text:`We expect to send our bills to you monthly. Our bills are due upon receipt. Invoices over 15 days aged are considered past due. Interest shall accrue on unpaid balances over 15 days at 1.5% simple interest. If we are not promptly paid, we reserve the right to withdraw from representing you or to suspend further service to you until such time as we reach a resolution regarding payment.` },
    { id:'s9', label:'9. Conflicts of Interest and Waiver', text:`We have evaluated this engagement for conflicts of interest on the basis that we represent only you in this matter. We are not presently aware of any conflicts except as more fully detailed below. The Firm may represent other companies and individuals in a variety of matters. It is possible that during the time we are representing you, some of our present or future clients may have transactions or disputes with you including litigation or other adversarial proceedings. You have agreed that the Firm may continue to represent or may undertake in the future to represent other clients in any matter not substantially related to our work for you, even if the interests of such clients in those other matters are directly adverse to you or a related entity, and even if such representations would be simultaneous. You also have agreed, as part of this prospective consent, that we may represent one or more of the parties opposite or adverse to you in this matter, in any future new matters unrelated to our work for you, even if such representations would be simultaneous. We agree, however, that your prospective consent to conflicting representations will not apply in an instance where, as the result of our representation of you, we have obtained sensitive, proprietary or other confidential or non-public information that, if known to any such other client of ours, could be used in any such other matter by such other client to your material disadvantage, and if screening procedures and similar measures would be insufficient to protect and maintain the confidentiality of that information.` },
    { id:'s10', label:'10. Specialist/Local Network and Fee Sharing', text:`For certain matters, I may recommend a specialist or engage an attorney to provide specialized advice or legal services to you. Additionally, in some instances, I may have fee sharing arrangement with certain specialists whereby a portion of such specialists\u2019 fees are paid to me and a portion of the fees are retained by such specialist. By executing this engagement letter, you hereby acknowledge and consent to: (1) the existence of my written agreement with such specialist to divide the fee and that such division of fees will be made; and (2) the identity of the individuals or firms that are parties to this division have been disclosed to you; (3) the terms of the division have been disclosed to you. Unless we agree otherwise in writing, you will be responsible for the fees and expenses of such outside professionals, whether they are retained by me or by you directly and you acknowledge the existence of and consent to any fee sharing arrangements between me and my recommended specialists.` },
    { id:'s11', label:'11. Use of Artificial Intelligence Tools', text:`The Firm may use artificial intelligence (\u201cAI\u201d) tools and software in connection with providing legal services to you, including but not limited to research, document review and drafting assistance. You hereby acknowledge and consent to our use of such AI tools subject to the following conditions: (1) all AI-generated work product will be reviewed, edited, and verified by qualified attorneys before being provided to you or relied upon in your matter; (2) we will not input your confidential information into AI systems that do not provide adequate data security and confidentiality protections; (3) you acknowledge that AI tools may have limitations, including potential for errors, biases, or incomplete analysis, and that such tools are used to supplement, not replace, professional legal judgment; (4) we will maintain appropriate oversight and quality control measures to ensure that any AI-assisted work meets our professional standards; (5) our use of AI tools does not diminish our professional responsibilities to you under applicable rules of professional conduct; and (6) you may request information about our AI usage policies or opt out of AI tool usage for your matter by providing written notice, though such opt-out may affect the efficiency and cost of our services. This consent shall remain in effect throughout our representation unless you revoke it in writing.` },
    { id:'s12', label:'12. Termination of Engagement', text:`You may terminate our engagement at any time by written notice. Likewise, the Firm may also terminate this engagement at any time by written notice, subject to applicable rules of professional conduct. In the event we terminate our representation, we will take such steps as are reasonably practicable to protect your interests in the above matter, and you agree to take all steps necessary to free us of any obligation to perform further. We reserve the right to withdraw from our representation if, among other things, you fail to honor the terms of this engagement letter, you fail to cooperate or follow our advice on a material matter, or any fact or circumstance would, in our view, render our continuing representation unlawful or unethical. If we elect to withdraw, you will cooperate with us in taking all steps necessary to complete our withdrawal. If our engagement terminates for any reason, you will remain responsible for paying for all services rendered and costs or expenses paid or incurred on your behalf through and including the date of any withdrawal or termination.` },
    { id:'s13', label:'13. Conclusion of Representation; Document Retention', text:`Unless previously terminated, our representation will conclude when we complete the specific services you have retained us to perform. At your request, we will return your papers and property to you upon our receipt of final payment. We will retain our own files pertaining to the matter, including, for example, firm administrative records, internal lawyers\u2019 work product such as drafts, notes, internal memoranda and legal and factual research.\n\nPlease retain all documents that we send you in accordance with your own records retention practices. All documents we retain will be transferred to the person responsible for administering our records retention program at the end of our representation. Unless we agree otherwise, documents and other materials we retain may be destroyed or disposed of within a reasonable time after termination or conclusion of this engagement. The firm discourages substantive or important communications with our clients by text message. The firm does not maintain text messages sent to or received from clients, or their contents, and does not consider text messages to be, and does not maintain text messages as, part of the client\u2019s file. Text messages are not retained as part of a client\u2019s file materials under our Document Retention Policy.` },
    { id:'s14', label:'14. Post-Engagement Matters', text:`You are engaging the Firm to provide legal services in connection with a specific matter. After the matter concludes, we may inform you from time to time of developments and changes in the law that might interest you, by newsletter or otherwise. These communications, however, do not create a new attorney-client relationship.\n\nAfter this matter is concluded, changes in law or circumstances may occur that could impact your future rights and liabilities. Unless you specifically engage us to provide advice on matters arising in the future, we have no continuing obligation to advise you with respect to future developments.` },
    { id:'s15', label:'15. Choice of Law & Venue', text:`The relationship between you and the Firm, including the validity, construction, and enforceability of this engagement letter, shall be governed in all respects by the law and professional conduct rules of Florida, without regard to conflicts of laws principles. The parties agree that any disputes arising under this engagement shall be brought in Palm Beach County, Florida.` },
    { id:'closing', label:'Closing', text:`This engagement letter, and the attached Exhibit A, constitutes the arrangement upon which we have agreed to undertake representation of the legal matters described in this letter. Please review the foregoing. If the arrangement described in this engagement letter is not acceptable to you in all respects, please call or email me. If it meets with your approval, kindly sign a copy of this letter on behalf of the Client and return it to me via email. When I receive the fully executed engagement letter, this engagement letter will constitute the arrangement between the Client and the Firm.\n\nThank you for retaining us and we look forward to working with you.` },
    { id:'exhibit', label:'Exhibit A \u2014 Scope of Services', text: matterDesc || '[Scope of services to be detailed here]' },
  ];

  return { meta, sections };
}

async function openLetterReview(data, clientId) {
  // Try to load the most recent saved version for this client
  try {
    const { data: latest, error } = await db.from('engagement_letters')
      .select('*')
      .eq('client_id', clientId)
      .order('version', { ascending: false })
      .limit(1)
      .single();

    if (!error && latest && latest.letter_data) {
      const ld = latest.letter_data;
      const versionDate = new Date(latest.created_at).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
      const versionLabel = `Saved version ${latest.version} from ${versionDate}`;
      const approvalData = {
        status: latest.approval_status || 'Draft',
        letterId: latest.id,
        reviewedBy: latest.reviewed_by || null,
        reviewNotes: latest.review_notes || null,
        assignedReviewer: latest.assigned_reviewer || null,
        createdByEmail: latest.created_by_email || null,
      };
      _lastSavedLetterId = latest.id;
      showLetterModal(ld.meta, ld.sections, clientId, ld.header, versionLabel, approvalData);
      return;
    }
  } catch (e) { /* no saved version — generate fresh */ }

  // No saved version found — generate from client data
  const { meta, sections } = buildLetterSections(data);
  showLetterModal(meta, sections, clientId);
}

function showLetterModal(meta, sections, clientId, headerOverrides, savedVersionLabel, approvalData) {
  _letterReviewMeta = meta;
  _letterReviewSections = sections;
  _letterClientId = clientId || null;
  _letterSavedThisSession = false;

  // Set approval state
  _letterApprovalStatus = (approvalData && approvalData.status) || null;
  _letterApprovalId = (approvalData && approvalData.letterId) || _lastSavedLetterId || null;
  _letterAssignedReviewer = (approvalData && approvalData.assignedReviewer) || null;

  const h = headerOverrides || {};
  const hDate = h.date || meta.engDate;
  const hRecipient = h.recipient || meta.clientLabel;
  const hAttention = h.attention || ((meta.contact || '') + (meta.title ? ', ' + meta.title : ''));
  const hEmail = h.email || meta.email;
  const hRe = h.re || `Engagement Letter \u2014 ${meta.matter} \u2014 ${meta.clientLabel}`;
  const hGreeting = h.greeting || `Dear ${meta.contact}:`;

  const container = document.getElementById('letterModalBody');
  let html = '';

  // Saved-version banner
  if (savedVersionLabel) {
    html += `<div class="doc-saved-banner"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${esc(savedVersionLabel)} &mdash; edit and re-download, or close to discard changes.</div>`;
  }

  // Approval workflow bar
  html += `<div id="approvalBarContainer"></div>`;

  // Header fields (date, recipient, re line, greeting)
  html += `<div class="letter-section"><div class="letter-section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg> Letter Header</div>`;
  html += `<div class="letter-section-row"><div class="letter-section-field"><label>Date</label><input type="text" id="rev_date" value="${esc(hDate)}"></div><div class="letter-section-field"><label>Recipient</label><input type="text" id="rev_recipient" value="${esc(hRecipient)}"></div></div>`;
  if (meta.isEntity && meta.contact) {
    html += `<div class="letter-section-row"><div class="letter-section-field"><label>Attention</label><input type="text" id="rev_attention" value="${esc(hAttention)}"></div><div class="letter-section-field"><label>Email</label><input type="text" id="rev_email" value="${esc(hEmail)}"></div></div>`;
  } else {
    html += `<div class="letter-section-row"><div class="letter-section-field"><label>Email</label><input type="text" id="rev_email" value="${esc(hEmail)}"></div><div class="letter-section-field"><label>Attorney</label><input type="text" id="rev_atty" value="${esc(meta.sigFull)}"></div></div>`;
  }
  html += `<div class="letter-section-row"><div class="letter-section-field" style="grid-column:1/-1;border-right:none;"><label>Re: Line</label><input type="text" id="rev_re" value="${esc(hRe)}" style="width:100%"></div></div>`;
  html += `<div class="letter-section-row"><div class="letter-section-field" style="grid-column:1/-1;border-right:none;"><label>Greeting</label><input type="text" id="rev_greeting" value="${esc(hGreeting)}" style="width:100%"></div></div>`;
  html += '</div>';

  // Editable sections with rich text toolbar
  sections.forEach(s => {
    const tall = s.text.length > 400 ? ' tall' : '';
    const editorHtml = textToEditorHtml(s.text);
    html += `<div class="letter-section"><div class="letter-section-header"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg> ${esc(s.label)}</div>`;
    html += `<div class="editor-toolbar"><button type="button" onmousedown="event.preventDefault()" onclick="document.execCommand('bold')" title="Bold (Ctrl+B)"><b>B</b></button><button type="button" onmousedown="event.preventDefault()" onclick="document.execCommand('italic')" title="Italic (Ctrl+I)"><i>I</i></button><button type="button" onmousedown="event.preventDefault()" onclick="document.execCommand('underline')" title="Underline (Ctrl+U)"><u>U</u></button></div>`;
    html += `<div contenteditable="true" id="rev_${s.id}" class="rich-editor${tall}">${editorHtml}</div></div>`;
  });

  // Email compose panel (rendered at bottom of letter body)
  if (isEmailEnabled()) {
    html += renderEmailComposePanel(meta);
  }

  // BoldSign e-sign compose panel
  if (isBoldsignEnabled()) {
    html += renderEsignComposePanel(meta);
  }

  container.innerHTML = html;

  // Strip rich HTML on paste — only allow plain text into contenteditable editors
  container.querySelectorAll('.rich-editor').forEach(ed => {
    ed.addEventListener('paste', e => {
      e.preventDefault();
      const text = e.clipboardData.getData('text/plain');
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(document.createTextNode(text));
      range.collapse(false);
      sel.removeAllRanges();
      sel.addRange(range);
    });
  });

  // Render the approval bar (always show — defaults to Draft for new letters)
  if (!_letterApprovalStatus) _letterApprovalStatus = 'Draft';
  updateApprovalBar(
    approvalData ? approvalData.reviewNotes : null,
    approvalData ? approvalData.reviewedBy : null
  );

  document.getElementById('letterModal').classList.add('visible');
  document.body.style.overflow = 'hidden';
  updateSlackUI();
  updateEmailUI();
}

function closeLetterModal() {
  document.getElementById('letterModal').classList.remove('visible');
  document.body.style.overflow = '';
  _letterReviewMeta = null;
  _letterReviewSections = null;
  _letterClientId = null;
  _letterSavedThisSession = false;
  _lastSavedLetterId = null;
  _letterApprovalStatus = null;
  _letterApprovalId = null;
  _letterAssignedReviewer = null;
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('docHistoryModal').classList.contains('visible')) {
      closeDocHistoryModal();
    } else if (document.getElementById('letterModal').classList.contains('visible')) {
      closeLetterModal();
    }
  }
});

// =============================================
// DOCUMENT HISTORY — VIEW, RE-OPEN, DELETE
// =============================================

function closeDocHistoryModal() {
  document.getElementById('docHistoryModal').classList.remove('visible');
  document.body.style.overflow = '';
}

async function downloadSignedCopy(letterId, storagePath) {
  try {
    const { data, error } = await db.storage
      .from('signed-letters')
      .createSignedUrl(storagePath, 60);
    if (error) throw error;
    const a = document.createElement('a');
    a.href = data.signedUrl;
    a.download = `Signed_Engagement_Letter.pdf`;
    a.target = '_blank';
    a.click();
  } catch (e) {
    showStatus('Error downloading signed copy: ' + e.message, 'error');
  }
}

async function fetchSignedCopy(letterId, btn) {
  const savedLabel = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<div class="loading-spinner" style="width:12px;height:12px;border-width:2px;"></div> Fetching...';

  try {
    let session = (await db.auth.getSession()).data.session;
    if (!session) throw new Error('Please sign in again.');

    const nowSec = Math.floor(Date.now() / 1000);
    if (session.expires_at && (session.expires_at - nowSec) < 120) {
      const { data: refreshData, error: refreshErr } = await db.auth.refreshSession();
      if (refreshErr || !refreshData.session) throw new Error('Session expired — please sign in again.');
      session = refreshData.session;
    }

    const res = await fetch(`${SUPABASE_URL}/functions/v1/fetch-signed-document`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${session.access_token}`,
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
      },
      body: JSON.stringify({ letterId }),
    });

    const result = await res.json();
    if (!res.ok) throw new Error(result.error || 'Failed to fetch signed document');

    // Download the file now that it's stored
    await downloadSignedCopy(letterId, result.path);

    // Replace the button with a green "Signed Copy" button
    btn.style.background = '#2E7D32';
    btn.disabled = false;
    btn.onclick = () => downloadSignedCopy(letterId, result.path);
    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Signed Copy`;
    showStatus('Signed copy retrieved and stored.', 'success');
  } catch (e) {
    showStatus('Error: ' + e.message, 'error');
    btn.disabled = false;
    btn.innerHTML = savedLabel;
  }
}

async function viewLetterHistory(clientId) {
  const modal = document.getElementById('docHistoryModal');
  const body = document.getElementById('docHistoryBody');
  const title = document.getElementById('docHistoryTitle');

  body.innerHTML = '<div style="text-align:center;padding:40px"><div class="loading-spinner" style="border-color:var(--border);border-top-color:var(--sage);width:24px;height:24px"></div></div>';
  modal.classList.add('visible');
  document.body.style.overflow = 'hidden';

  try {
    const clients = await getClients();
    const client = clients.find(c => c.id === clientId);
    title.textContent = client ? `Documents \u2014 ${clientDisplayName(client)}` : 'Document History';

    const { data, error } = await db.from('engagement_letters')
      .select('*')
      .eq('client_id', clientId)
      .order('version', { ascending: false });

    if (error) throw error;

    if (!data || data.length === 0) {
      body.innerHTML = '<div class="empty-state"><p>No saved letters yet.</p><p class="help-text" style="margin-top:8px">Letters are automatically saved when you download or send to Slack.</p></div>';
      return;
    }

    let html = `<p style="font-size:12px;color:var(--warm-gray);margin-bottom:16px">${data.length} version${data.length!==1?'s':''} saved</p>`;
    data.forEach(letter => {
      const date = new Date(letter.created_at).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });
      html += `<div class="doc-version-card" data-letter-id="${esc(letter.id)}">
        <div class="doc-version-info">
          <div class="doc-version-badge">v${letter.version}</div>
          <div>
            <div class="doc-version-name">${esc(letter.file_name)}${letter.approval_status ? ` <span class="approval-pill ${({'Draft':'approval-draft','Pending Review':'approval-pending','Approved':'approval-approved','Changes Requested':'approval-changes','Executed':'approval-executed'})[letter.approval_status] || 'approval-draft'}">${esc(letter.approval_status)}</span>` : ''}</div>
            <div class="doc-version-detail">${esc(date)} \u00b7 ${esc(letter.created_by_email || 'Unknown')}</div>
          </div>
        </div>
        <div class="doc-version-actions">
          ${letter.signed_pdf_path ? `<button class="btn btn-sm" style="background:#2E7D32;color:#fff;" onclick="downloadSignedCopy('${esc(letter.id)}','${esc(letter.signed_pdf_path)}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Signed Copy</button>` : (letter.esign_status === 'completed' || letter.esign_status === 'signed') ? `<button class="btn btn-sm" style="background:var(--amber);color:#fff;" onclick="fetchSignedCopy('${esc(letter.id)}',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Fetch Signed</button>` : ''}
          <button class="btn btn-secondary btn-sm" onclick="openSavedLetter('${esc(letter.id)}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg> Review</button>
          <button class="btn btn-danger btn-sm" onclick="deleteLetterVersion('${esc(letter.id)}')">&#10005;</button>
        </div>
      </div>`;
    });

    body.innerHTML = html;
  } catch (e) {
    const msg = (e.message || '').toLowerCase();
    if (msg.includes('relation') || msg.includes('does not exist') || msg.includes('42P01')) {
      body.innerHTML = '<div class="empty-state"><p>Document storage not set up yet.</p><p class="help-text" style="margin-top:12px">Run the SQL migration in Supabase to enable this feature.<br>See the code comments in index.html for the migration script.</p></div>';
    } else {
      body.innerHTML = `<div class="empty-state"><p>Error loading documents.</p><p class="help-text" style="margin-top:8px">${esc(e.message)}</p></div>`;
    }
  }
}

async function openSavedLetter(letterId) {
  try {
    const { data, error } = await db.from('engagement_letters')
      .select('*')
      .eq('id', letterId)
      .single();

    if (error) throw error;

    closeDocHistoryModal();

    const ld = data.letter_data;
    const versionDate = new Date(data.created_at).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
    const versionLabel = `Saved version ${data.version} from ${versionDate}`;

    const approvalData = {
      status: data.approval_status || 'Draft',
      letterId: data.id,
      reviewedBy: data.reviewed_by || null,
      reviewNotes: data.review_notes || null,
      assignedReviewer: data.assigned_reviewer || null,
      createdByEmail: data.created_by_email || null,
    };

    // Sync saved-letter ID so subsequent saves update the correct record
    _lastSavedLetterId = data.id;

    showLetterModal(ld.meta, ld.sections, data.client_id, ld.header, versionLabel, approvalData);
  } catch (e) {
    showStatus('Error opening letter: ' + e.message, 'error');
  }
}

async function deleteLetterVersion(letterId) {
  if (!confirm('Delete this saved letter version? This cannot be undone.')) return;
  try {
    const { error } = await db.from('engagement_letters').delete().eq('id', letterId);
    if (error) throw error;
    // Re-render the list: find the card and remove it via data attribute
    const card = document.querySelector(`.doc-version-card[data-letter-id="${CSS.escape(letterId)}"]`);
    if (card) card.remove();
    showStatus('Letter version deleted.', 'success');
  } catch (e) {
    showStatus('Error: ' + e.message, 'error');
  }
}

async function downloadFromReview() {
  if (!_letterReviewMeta || !_letterReviewSections) return;

  const dlBtns = document.querySelectorAll('[onclick="downloadFromReview()"]');
  const savedLabels = [];
  dlBtns.forEach(b => { savedLabels.push(b.innerHTML); b.disabled = true; b.innerHTML = '<div class="loading-spinner"></div> Generating...'; });

  try {
  const meta = _letterReviewMeta;
  const blob = await buildDocxBlob();
  if (!blob) throw new Error('Failed to generate document');

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Engagement_Letter_${meta.name.replace(/[^a-zA-Z0-9]/g,'_')}.docx`;
  a.click();
  URL.revokeObjectURL(url);

  // Save letter to document storage (fire-and-forget)
  saveLetterToDb();

  closeLetterModal();
  showStatus(`\u2713 Engagement letter downloaded for ${meta.name}.`,'success');

  } catch(err) {
    showStatus('Error generating letter: ' + err.message, 'error');
  } finally {
    dlBtns.forEach((b,i) => { b.disabled = false; b.innerHTML = savedLabels[i]; });
  }
}



async function generateAll(){if(!validateForm())return;const d=getFormData();const btn=document.getElementById('generateBtn');btn.disabled=true;btn.innerHTML='<div class="loading-spinner"></div> Generating...';try{const saved=await addClient(d);if(saved){exportSingleClientExcel(saved);openLetterReview(d,saved.id);showStatus(`\u2713 ${clientDisplayName(d)} added \u2013 review your letter.`,'success');resetForm();}}catch(e){showStatus('Error: '+e.message,'error');}finally{btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg> Generate Letter + Add to Tracker';}}

async function addToTrackerOnly(){if(!validateForm())return;const d=getFormData();const btn=document.getElementById('trackerBtn');btn.disabled=true;btn.innerHTML='<div class="loading-spinner"></div> Adding...';try{const saved=await addClient(d);if(saved){showStatus(`\u2713 ${clientDisplayName(d)} added.`,'success');resetForm();}}finally{btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg> Add to Tracker Only';}}

async function regenLetter(id){const clients=await getClients();const c=clients.find(x=>x.id===id);if(!c)return;openLetterReview(c,c.id);}

checkAuth();
</script>
</body>
</html>
